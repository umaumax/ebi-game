<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åà„Å≥„Å°„ÇÉ„ÇìÔºà‰ªÆÔºâ</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶ê</text></svg>">
    <meta property="og:title" content="„Åà„Å≥„Å°„ÇÉ„ÇìÔºà‰ªÆÔºâ">
    <meta property="og:description" content="Ëø´„Çä„Åè„ÇãÂ§©Êïµ„ÇíÈÅø„Åë„Å™„Åå„Çâ„Å©„Çå„Å†„ÅëÈï∑„ÅèÊ≥≥„Åí„Çã„Åã„ÇíÁ´∂„ÅÜ„Ç∑„É≥„Éó„É´ÂõûÈÅø„Ç¢„ÇØ„Ç∑„Éß„É≥„Ç≤„Éº„É†">
    <meta property="og:image" content="https://umaumax.github.io/ebi-game/ebi-game-screenshot.png">
    <meta property="og:url" content="https://umaumax.github.io/ebi-game/">
    <meta name="twitter:card" content="summary_large_image">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB; /* Ê∞¥Ëâ≤ */
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* „ÉÄ„Éñ„É´„Çø„ÉÉ„ÉóÊã°Â§ßÈò≤Ê≠¢ */
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 0 #000;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }
        .level-display {
            position: absolute;
            top: 20px;
            right: 80px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }
        .message-box {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            pointer-events: auto; /* „Éú„Çø„É≥„Å™„Å©„ÇíÊäº„Åõ„Çã„Çà„ÅÜ„Å´ */
        }
        h1 {
            margin: 0 0 10px 0;
            color: #FF6F61;
            font-size: 32px;
        }
        p {
            margin: 10px 0;
            color: #333;
            font-size: 16px;
            line-height: 1.5;
        }
        .blink {
            animation: blinker 0.8s ease-in-out infinite alternate;
            background-color: #FF6F61;
            color: white;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 30px;
            margin-top: 20px;
            display: inline-block;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 111, 97, 0.4);
            user-select: none;
            -webkit-user-select: none;
        }
        @keyframes blinker {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.1); opacity: 0.9; }
        }
        /* „Çπ„Éû„ÉõÂêë„ÅëË™øÊï¥ */
        @media (max-width: 600px) {
            h1 { font-size: 24px; }
            p { font-size: 14px; }
        }
        .life-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            color: #FF6F61;
        }
        .level-up-msg {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px #000;
            pointer-events: none;
            opacity: 0;
        }
        .level-up-msg.animate {
            animation: fadeUp 2s forwards;
        }
        @keyframes fadeUp {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5); }
        }
        #pause-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #fff;
            border-radius: 50%;
            font-weight: bold;
            font-size: 20px;
            color: #333;
            pointer-events: auto;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        .warning-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            font-weight: bold;
            color: #FF0000;
            text-shadow: 3px 3px 0 #000;
            display: none;
            z-index: 200;
        }
        .warning-msg.active {
            display: block;
            animation: blinker 0.2s linear infinite;
        }
        .difficulty-select {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .diff-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: bold;
            cursor: pointer;
            color: white;
            font-size: 16px;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="score-display">
        DISTANCE: <span id="score">0</span>m<br>
        <span style="font-size: 0.6em; color: #eee;">HI: <span id="high-score">0</span>m</span>
    </div>
    
    <div class="level-display">LV: <span id="level">1</span></div>

    <div id="life-display" class="life-display">‚ù§‚ù§‚ù§</div>
    
    <div id="level-up-msg" class="level-up-msg">LEVEL UP!</div>
    
    <div id="pause-btn">II</div>

    <div id="warning-msg" class="warning-msg">WARNING!</div>

    <div id="start-screen" class="message-box">
        <h1>„Åà„Å≥„Å°„ÇÉ„ÇìÔºà‰ªÆÔºâ</h1>
        <p>Ê≥≥„ÅêÔºö„Çø„ÉÉ„Éó / „Çπ„Éö„Éº„Çπ</p>
        <p>Èõ£ÊòìÂ∫¶„ÇíÈÅ∏„Çì„Åß„Çπ„Çø„Éº„Éà</p>
        <div class="difficulty-select">
            <button id="btn-easy" class="diff-btn" style="background-color: #4CAF50;">EASY</button>
            <button id="btn-normal" class="diff-btn" style="background-color: #2196F3;">NORMAL</button>
            <button id="btn-hard" class="diff-btn" style="background-color: #f44336;">HARD</button>
        </div>
    </div>

    <div id="gameover-screen" class="message-box" style="display: none;">
        <h1>GAME OVER</h1>
        <img id="screenshot" style="width: 100%; max-width: 400px; height: auto; border-radius: 10px; margin: 10px auto; border: 2px solid #333; display: block;">
        <p>Ë®òÈå≤: <span id="final-score">0</span>m</p>
        <p id="rank-display" style="font-size: 20px; color: #FFD700; font-weight: bold; text-shadow: 1px 1px 2px black; margin: 5px 0;"></p>
        <p style="color: #FF4500; font-weight: bold;">Ê≠ªÂõ†: <span id="death-reason">‰∏çÊòé</span></p>
        <div class="blink">TAP TO RETRY</div>
        <button id="gameover-download-ss-btn" class="diff-btn" style="background-color: #00BCD4; margin-top: 10px; display: block; margin-left: auto; margin-right: auto;">„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Çí‰øùÂ≠ò</button>
        <button id="replay-btn" style="margin-top: 10px; padding: 10px 20px; background-color: #FF8C00; color: white; border: none; border-radius: 20px; font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: bold; cursor: pointer; font-size: 14px; display: block; margin-left: auto; margin-right: auto;">üé• „ÉÄ„Ç§„Ç∏„Çß„Çπ„ÉàÂÜçÁîü</button>
        <button id="share-btn" style="margin-top: 15px; padding: 10px 20px; background-color: #000; color: white; border: none; border-radius: 20px; font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: bold; cursor: pointer; font-size: 14px;">X„Åß„Ç∑„Çß„Ç¢</button>
    </div>

    <div id="pause-screen" class="message-box" style="display: none;">
        <h1>PAUSED</h1>
        <button id="download-ss-btn" class="diff-btn" style="background-color: #00BCD4; margin-top: 10px;">„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„Çí‰øùÂ≠ò</button>
        <div class="blink">TAP TO RESUME</div>
    </div>

    <div id="replay-ui" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); pointer-events: auto; display: none;">
        <button id="skip-replay-btn" class="diff-btn" style="background-color: #757575;">SKIP</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/**
 * „Ç≤„Éº„É†‰ªïÊßòÂÆöÊï∞
 */
const CONSTANTS = {
    GRAVITY: 0.15,
    JUMP_FORCE_Y: -5.0, // ‰∏äÊñπÂêë„Å∏„ÅÆÂäõ
    JUMP_FORCE_X: -4.0, // ÂæåÊñπ„Å∏„ÅÆÂäõÔºà„Éê„ÉÉ„ÇØÔºâ
    AUTO_FORWARD_SPEED: 1.5, // ‰Ωï„ÇÇ„Åó„Å™„ÅÑÊôÇ„Å´ÂâçÔºàÂè≥Ôºâ„Å´Êàª„ÇãÂäõ
    SCROLL_SPEED: 3.5, // ËÉåÊôØ„ÉªÊïµ„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÈÄüÂ∫¶
    SHRIMP_COLOR: '#FF6F61',
    SHRIMP_BASE_SIZE: 20,
    MAX_LIVES: 5,
    BOSS_INTERVAL: 300 // „Éú„ÇπÂá∫ÁèæÈñìÈöî(m)
};

/**
 * „Ç≤„Éº„É†„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
 */
const STATE = {
    START: 0,
    PLAYING: 1,
    GAMEOVER: 2,
    PAUSED: 3,
    BITTEN: 4, // „Éí„É©„É°„Å´È£ü„Åπ„Çâ„Çå„Å¶„ÅÑ„ÇãÁä∂ÊÖã
    REPLAY: 5  // „É™„Éó„É¨„Ç§ÂÜçÁîü‰∏≠
};

/**
 * Èü≥Â£∞ÁÆ°ÁêÜ„ÇØ„É©„Çπ (Web Audio API)
 */
class SoundManager {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.bgmTimer = null;
        this.bgmStep = 0;
        this.bgmTempo = 250;
        this.bgmPitchRate = 1.0;
    }

    init() {
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    }

    playTone(freq, type, duration, vol = 0.1) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }

    playJump() {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.frequency.setValueAtTime(300, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.1);
    }

    playHit() {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(20, this.ctx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + 0.3);
    }

    playItem() {
        this.playTone(1200, 'sine', 0.1, 0.1);
        setTimeout(() => this.playTone(1800, 'sine', 0.2, 0.1), 50);
    }
    
    playBubble() {
        this.playTone(800 + Math.random() * 200, 'sine', 0.05, 0.02);
    }
    
    playNoise(vol = 0.1) {
        if (this.ctx.state !== 'running') return;
        // Á∞°ÊòìÁöÑ„Å™„Éé„Ç§„Ç∫ÁîüÊàêÔºàÊøÄÊµÅÈü≥Ôºâ
        const bufferSize = this.ctx.sampleRate * 0.1;
        const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * 0.5;
        }
        const noise = this.ctx.createBufferSource();
        noise.buffer = buffer;
        const gain = this.ctx.createGain();
        gain.gain.value = vol;
        noise.connect(gain);
        gain.connect(this.ctx.destination);
        noise.start();
    }

    setBGMParams(score, inRapidCurrentZone) {
        // „Çπ„Ç≥„Ç¢(Ê∑±Â∫¶)„Å´Âøú„Åò„Å¶„ÉÜ„É≥„Éù„ÇíÈÅÖ„Åè„ÄÅ„Éî„ÉÉ„ÉÅ„Çí‰Ωé„Åè„Åô„Çã
        // 0m: 250ms, 1.0
        // 2000m: 400ms, 0.6
        const ratio = Math.min(score / 2000, 1.0);
        this.bgmTempo = 250 + ratio * 150;
        this.bgmPitchRate = 1.0 - ratio * 0.4;
        
        if (inRapidCurrentZone) {
            this.bgmTempo *= 0.5; // „ÉÜ„É≥„Éù„Ç¢„ÉÉ„ÉóÔºà„Åï„Çâ„Å´ÈÄü„ÅèÔºâ
            this.bgmPitchRate += 0.5; // „Éî„ÉÉ„ÉÅ„Ç¢„ÉÉ„ÉóÔºà„Åï„Çâ„Å´È´ò„ÅèÔºâ
        }
    }

    startBGM() {
        if (this.bgmTimer) return;
        this.playBGMStep();
    }

    playBGMStep() {
        const notes = [196, 0, 261, 0, 220, 0, 196, 0]; // G3, C4, A3, G3
        
        if (this.ctx.state !== 'suspended') {
            const baseFreq = notes[this.bgmStep % notes.length];
            if (baseFreq > 0) {
                this.playTone(baseFreq * this.bgmPitchRate, 'triangle', 0.2, 0.03);
            }
        }
        this.bgmStep++;
        this.bgmTimer = setTimeout(() => this.playBGMStep(), this.bgmTempo);
    }

    stopBGM() {
        if (this.bgmTimer) {
            clearTimeout(this.bgmTimer);
            this.bgmTimer = null;
        }
    }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width;
        this.canvas.height = this.height;

        this.state = STATE.START;
        this.score = 0;
        this.highScore = parseInt(localStorage.getItem('ebi_highscore')) || 0;
        this.frameCount = 0;
        this.lives = 3;
        this.level = 0;
        this.scrollSpeed = CONSTANTS.SCROLL_SPEED;
        this.difficulty = 'NORMAL';
        this.scrollOffset = 0;
        this.isRapidCurrent = false;
        this.rapidCurrentY = 0; // ÊøÄÊµÅ„ÅÆ‰∏≠ÂøÉYÂ∫ßÊ®ô
        this.inRapidCurrentZone = false; // „Éó„É¨„Ç§„É§„Éº„ÅåÊøÄÊµÅ„Å´Â∑ª„ÅçËæº„Åæ„Çå„Å¶„ÅÑ„Çã„Åã
        this.rapidCurrentTimer = 0;
        this.streamLines = []; // ÊøÄÊµÅ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
        this.replayBuffer = []; // „É™„Éó„É¨„Ç§Áî®„Éá„Éº„Çø
        this.replayIndex = 0;
        this.replayDummies = {}; // „É™„Éó„É¨„Ç§ÊèèÁîªÁî®„ÅÆ„ÉÄ„Éü„Éº„Ç§„É≥„Çπ„Çø„É≥„Çπ
        this.lastBossDistance = 0;
        this.sound = new SoundManager();

        this.player = new Shrimp(this.width / 3, this.height / 2);
        this.enemies = [];
        this.items = []; // „Éë„Éº„É´„Å™„Å©
        this.backgroundObjects = []; // ËÉåÊôØÔºàÈ≠ö„ÅÆ„Ç∑„É´„Ç®„ÉÉ„Éà„ÄÅÊ≤àÊ≤°ËàπÔºâ
        this.decorations = []; // „Çè„Åã„ÇÅ„ÄÅÂ≤©„ÄÅ„Çµ„É≥„Ç¥
        this.particles = [];
        this.floatingTexts = []; // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„Éà

        // UIË¶ÅÁ¥†
        this.uiScore = document.getElementById('score');
        this.uiLevel = document.getElementById('level');
        this.uiLife = document.getElementById('life-display');
        this.uiHighScore = document.getElementById('high-score');
        this.uiFinalScore = document.getElementById('final-score');
        this.uiDeathReason = document.getElementById('death-reason');
        this.uiRank = document.getElementById('rank-display');
        this.uiLevelUp = document.getElementById('level-up-msg');
        this.uiPauseBtn = document.getElementById('pause-btn');
        this.uiWarning = document.getElementById('warning-msg');
        this.screenStart = document.getElementById('start-screen');
        this.screenGameOver = document.getElementById('gameover-screen');
        this.screenPause = document.getElementById('pause-screen');

        this.screenshotTaken = false;

        // UI for replay
        this.uiReplay = document.getElementById('replay-ui');
        this.btnSkipReplay = document.getElementById('skip-replay-btn');

        // „É™„Éó„É¨„Ç§Áî®„ÉÄ„Éü„Éº„ÅÆÂàùÊúüÂåñ
        this.initReplayDummies();

        // Èõ£ÊòìÂ∫¶„Éú„Çø„É≥
        this.btnEasy = document.getElementById('btn-easy');
        this.btnNormal = document.getElementById('btn-normal');
        this.btnHard = document.getElementById('btn-hard');

        const startHandler = (diff) => (e) => {
            e.stopPropagation();
            if (this.state !== STATE.START) return;
            this.sound.init();
            this.startGame(diff);
        };
        ['mousedown', 'touchstart'].forEach(evt => this.btnEasy.addEventListener(evt, startHandler('EASY')));
        ['mousedown', 'touchstart'].forEach(evt => this.btnNormal.addEventListener(evt, startHandler('NORMAL')));
        ['mousedown', 'touchstart'].forEach(evt => this.btnHard.addEventListener(evt, startHandler('HARD')));

        // „É™„Éó„É¨„Ç§„Éú„Çø„É≥
        this.btnReplay = document.getElementById('replay-btn');
        const replayHandler = (e) => { e.stopPropagation(); this.startReplay(); };
        ['mousedown', 'touchstart'].forEach(evt => this.btnReplay.addEventListener(evt, replayHandler));

        // „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥
        const skipReplayHandler = (e) => { e.stopPropagation(); this.gameOver(this.deathReason); };
        ['mousedown', 'touchstart'].forEach(evt => this.btnSkipReplay.addEventListener(evt, skipReplayHandler));

        // „Çπ„ÇØ„Ç∑„Éß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
        this.btnDownloadSS = document.getElementById('download-ss-btn');
        const downloadSSHandler = (e) => {
            e.stopPropagation();
            const link = document.createElement('a');
            link.download = `ebi-game-screenshot-${Date.now()}.png`;
            link.href = this.canvas.toDataURL('image/png');
            link.click();
        };
        ['mousedown', 'touchstart'].forEach(evt => this.btnDownloadSS.addEventListener(evt, downloadSSHandler));

        // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢„ÅÆ„Çπ„ÇØ„Ç∑„Éß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
        this.btnGameoverDownloadSS = document.getElementById('gameover-download-ss-btn');
        const gameoverDownloadSSHandler = (e) => {
            e.stopPropagation();
            const link = document.createElement('a');
            link.download = `ebi-game-result-${Date.now()}.png`;
            link.href = this.gameOverResultURL || this.canvas.toDataURL('image/png');
            link.click();
        };
        ['mousedown', 'touchstart'].forEach(evt => this.btnGameoverDownloadSS.addEventListener(evt, gameoverDownloadSSHandler));

        // „Ç∑„Çß„Ç¢„Éú„Çø„É≥
        this.btnShare = document.getElementById('share-btn');
        this.btnShare.addEventListener('click', (e) => {
            e.stopPropagation();
            const text = `„Åà„Å≥„Å°„ÇÉ„ÇìÔºà‰ªÆÔºâ„Åß${Math.floor(this.score)}mÊ≥≥„Åé„Åæ„Åó„ÅüÔºÅ\nÊ≠ªÂõ†: ${this.deathReason}\nÈõ£ÊòìÂ∫¶: ${this.difficulty}`;
            const baseUrl = 'https://umaumax.github.io/ebi-game/';
            const hashtags = '„Åà„Å≥„Å°„ÇÉ„Çì„Ç≤„Éº„É†';

            // OGPÁîªÂÉè„ÇíÂãïÁöÑ„Å´ÁîüÊàê„Åô„Çã„Åü„ÇÅ„ÅÆURL„Çí‰ΩúÊàê
            const ogpParams = `score=${Math.floor(this.score)}&rank=${encodeURIComponent(this.getRank(this.score))}&reason=${encodeURIComponent(this.deathReason)}`;
            // „Åì„ÅÆURL„ÅØVercelÁ≠â„ÅÆ„Çµ„Éº„Éê„Éº„É¨„ÇπÈñ¢Êï∞„ÇíÊÉ≥ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô
            const ogpImageUrl = `https://your-serverless-function-url/api/ogp?${ogpParams}`;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(baseUrl)}&hashtags=${encodeURIComponent(hashtags)}`;
            window.open(twitterUrl, '_blank');
        });

        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.setupInput();
        
        this.updateLifeDisplay();
        this.uiHighScore.innerText = this.highScore;
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    initReplayDummies() {
        // „ÇØ„É©„ÇπÂêç„Åã„Çâ„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇíÂºï„Åë„Çã„Çà„ÅÜ„Å´„Éû„ÉÉ„Éó„Çí‰ΩúÊàê
        const classes = [
            Fish, Sardine, Tuna, Shark, Anglerfish, Hook, Net, Squid, Flatfish, 
            SeaUrchin, Octopus, Porcupinefish, Needle, Whirlpool, Whale, WaterSpout, WaterDrop, Jellyfish, Crab, SeaAnemone, Starfish, ElectricEel,
            Pearl, Plankton, FriendShrimp, Clownfish, GardenEel, TreasureChest,
            Shipwreck,
            Seaweed, RuggedTerrain, Coral, StreamLine, Bubble
        ];
        classes.forEach(cls => {
            try {
                // ÂºïÊï∞„Å™„Åó„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÈÅ©ÂΩì„Å™ÂºïÊï∞„Åß„Ç§„É≥„Çπ„Çø„É≥„ÇπÂåñ
                // ‰∏ÄÈÉ®„ÅÆ„ÇØ„É©„Çπ„ÅØÂºïÊï∞„ÅåÂøÖË¶Å„Å†„Åå„ÄÅÊèèÁîª„Å´‰Ωø„ÅÜ„Éó„É≠„Éë„ÉÜ„Ç£„ÅØÂæå„Åß‰∏äÊõ∏„Åç„Åô„Çã„ÅÆ„Åß„Ç®„É©„Éº„Å´„Å™„Çâ„Å™„Åë„Çå„Å∞OK
                if (cls === Shark) this.replayDummies[cls.name] = new cls(0, 0, null);
                else if (cls === Porcupinefish) this.replayDummies[cls.name] = new cls(0, 0, this);
                else this.replayDummies[cls.name] = new cls(0, 0);
            } catch (e) {
                console.error("Dummy init failed for", cls.name, e);
            }
        });
        this.replayDummies['Shrimp'] = new Shrimp(0, 0);
    }

    resize() {
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width;
        this.canvas.height = this.height;
    }

    setupInput() {
        const action = (e) => {
            this.sound.init(); // „É¶„Éº„Ç∂„ÉºÊìç‰Ωú„Åß„Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÈñãÂßã
            
            // „Éú„Çø„É≥Êìç‰ΩúÊôÇ„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„Éú„Çø„É≥„ÅÆ„Éè„É≥„Éâ„É©„Å´‰ªª„Åõ„ÇãÔºâ
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;

            // „Éù„Éº„Ç∫„Éú„Çø„É≥
            if (e.target === this.uiPauseBtn) {
                this.togglePause();
                return;
            }

            if (e.type === 'keydown' && !(e.code === 'Space')) return;
            if (e.type === 'touchstart') e.preventDefault(); // „Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢

            if (this.state === STATE.START) {
                // „Çπ„Éö„Éº„Çπ„Ç≠„Éº„Åß„ÇÇNORMAL„ÅßÈñãÂßã„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
                if (e.type === 'keydown' && e.code === 'Space') {
                    this.btnNormal.style.transform = 'scale(1.1)';
                    this.btnNormal.style.boxShadow = '0 0 15px #2196F3';
                    setTimeout(() => { this.btnNormal.style.transform = ''; this.btnNormal.style.boxShadow = ''; }, 200);
                    this.startGame('NORMAL');
                }
            } else if (this.state === STATE.PLAYING) {
                this.player.jump();
                this.sound.playJump();
            } else if (this.state === STATE.PAUSED) {
                this.togglePause();
            } else if (this.state === STATE.GAMEOVER) {
                // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„É™„Çπ„Çø„Éº„ÉàÂèØËÉΩ„Å´ÔºàË™§Êìç‰ΩúÈò≤Ê≠¢Ôºâ
                if (this.frameCount > 30) this.resetGame();
            } else if (this.state === STATE.REPLAY) {
                // „É™„Éó„É¨„Ç§‰∏≠„ÅØ„Çø„ÉÉ„Éó„ÅßÁµÇ‰∫Ü
                this.gameOver(this.deathReason);
            }
        };

        window.addEventListener('keydown', action);
        window.addEventListener('touchstart', action, { passive: false });
        window.addEventListener('mousedown', action);
    }

    togglePause() {
        if (this.state === STATE.PLAYING) {
            this.state = STATE.PAUSED;
            this.screenPause.style.display = 'block';
            this.uiPauseBtn.style.display = 'none';
            this.sound.stopBGM();
        } else if (this.state === STATE.PAUSED) {
            this.state = STATE.PLAYING;
            this.screenPause.style.display = 'none';
            this.uiPauseBtn.style.display = 'flex';
            this.sound.startBGM();
        }
    }

    startGame(difficulty = 'NORMAL') {
        this.difficulty = difficulty;
        this.state = STATE.PLAYING;
        this.screenStart.style.display = 'none';
        this.screenGameOver.style.display = 'none';
        this.score = 0;
        this.lives = 3;
        this.updateLifeDisplay();
        this.level = 0;
        
        // Èõ£ÊòìÂ∫¶„Å´„Çà„ÇãÂàùÊúüÈÄüÂ∫¶Ë®≠ÂÆö
        if (this.difficulty === 'EASY') this.scrollSpeed = 3.0;
        else if (this.difficulty === 'HARD') this.scrollSpeed = 5.0;
        else this.scrollSpeed = CONSTANTS.SCROLL_SPEED; // 3.0

        this.lastBossDistance = 0;
        this.uiWarning.classList.remove('active');
        this.frameCount = 0;
        this.scrollOffset = 0;
        this.isRapidCurrent = false;
        this.rapidCurrentTimer = 0;
        this.streamLines = [];
        this.backgroundObjects = [];
        this.screenshotTaken = false;
        this.replayBuffer = [];
        this.sound.startBGM();
        this.enemies = [];
        this.items = [];
        this.decorations = [];
        this.particles = [];
        this.floatingTexts = [];
        this.player.reset(this.width / 3, this.height / 2);
        this.updatePlayerSize();
    }

    resetGame() {
        this.state = STATE.START;
        this.screenStart.style.display = 'block';
        this.screenGameOver.style.display = 'none';
        this.sound.stopBGM();
    }

    startReplay() {
        this.state = STATE.REPLAY;
        this.screenGameOver.style.display = 'none';
        this.uiReplay.style.display = 'block'; 
        // ÊúÄÂæå„ÅÆ3ÁßíÈñì„Å†„ÅëÂÜçÁîü (30fps * 3s = 90„Éï„É¨„Éº„É†)
        this.replayIndex = Math.max(0, this.replayBuffer.length - 90);
    }

    updateLifeDisplay() {
        let hearts = '';
        for(let i=0; i<this.lives; i++) hearts += '‚ù§';
        this.uiLife.innerText = hearts;
    }

    updatePlayerSize() {
        // „É©„Ç§„Éï„ÅåÂ¢ó„Åà„Çã„Å®„Çµ„Ç§„Ç∫ÔºàÂΩì„Åü„ÇäÂà§ÂÆöÔºâ„ÅåÂ§ß„Åç„Åè„Å™„Çã‰ªïÊßò
        // „É©„Ç§„Éï3„ÇíÂü∫Ê∫ñ(20px)„Å®„Åó„ÄÅÂ¢óÊ∏õ„Åß„Çµ„Ç§„Ç∫Â§âÂåñ
        if (this.player) {
            const size = CONSTANTS.SHRIMP_BASE_SIZE + (this.lives - 3) * 5;
            this.player.radius = Math.max(10, size); // ÊúÄÂ∞è10px„ÅØÁ¢∫‰øù
        }
    }

    hitPlayer(reason = "‰∏çÊòé") {
        if (this.player.isInvincible) return;

        this.sound.playHit();
        this.lives--;
        this.updateLifeDisplay();
        this.updatePlayerSize();
        this.deathReason = reason;
        
        if (this.lives <= 0) {
            this.gameOver(reason);
        } else {
            // „ÉÄ„É°„Éº„Ç∏ÊºîÂá∫„Å®ÁÑ°ÊïµÊôÇÈñì
            this.player.setInvincible(60); // 60„Éï„É¨„Éº„É†ÁÑ°Êïµ
            // ÁîªÈù¢„ÇíËµ§„Åè„Éï„É©„ÉÉ„Ç∑„É•„Åï„Åõ„Çã„Å™„Å©„ÅÆÊºîÂá∫„ÇÇÂèØ
            this.ctx.fillStyle = 'rgba(255,0,0,0.3)';
            this.ctx.fillRect(0,0,this.width,this.height);
        }
    }

    triggerFlatfishDeath(flatfish) {
        // „Éí„É©„É°„Å´È£ü„Åπ„Çâ„Çå„ÇãÊºîÂá∫ÈñãÂßã
        this.sound.playHit();
        this.state = STATE.BITTEN;
        this.bittenTimer = 0;
        this.killerEnemy = flatfish;
        // „Éó„É¨„Ç§„É§„Éº„Çí„Éí„É©„É°„ÅÆ‰ΩçÁΩÆ„Å´Âõ∫ÂÆöÔºàÊçïÈ£ü„Åï„Çå„ÅüË°®ÁèæÔºâ
        this.player.x = flatfish.x;
        this.player.y = flatfish.y;
        this.deathReason = "„Éí„É©„É°„Å´È£ü„Åπ„Çâ„Çå„Åü";
    }

    getGroundY(x) {
        const base = this.height - 50;
        // „ÅÜ„Å≠„ÅÜ„Å≠„Åï„Åõ„Çã
        return base + Math.sin((x + this.scrollOffset) * 0.005) * 20 + Math.sin((x + this.scrollOffset) * 0.02) * 10;
    }

    addFloatingText(x, y, text, color) {
        this.floatingTexts.push(new FloatingText(x, y, text, color));
    }

    getRank(score) {
        if (score < 100) return "Ëø∑Â≠ê„ÅÆ„Ç®„Éì";
        if (score < 300) return "„ÅäÊï£Ê≠©„Ç®„Éì";
        if (score < 500) return "ÂÜíÈô∫ËÄÖ";
        if (score < 1000) return "Ê∑±Êµ∑„ÅÆÊóÖ‰∫∫";
        if (score < 2000) return "Ê∑±Ê∑µ„ÇíË¶ó„ÅèËÄÖ";
        if (score < 3000) return "Ê∑±Êµ∑„ÅÆ‰∏ª";
        if (score < 5000) return "‰ºùË™¨„ÅÆÊµ∑ËÄÅ";
        return "Ê∑±Êµ∑„ÅÆË¶áËÄÖ";
    }

    gameOver(reason) {
        this.state = STATE.GAMEOVER;
        this.screenGameOver.style.display = 'block';
        
        // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºUI„ÇíÊèèÁîª„Åó„ÅüÁä∂ÊÖã„ÅÆCanvas„Çí‰øùÂ≠ò
        if (!this.screenshotTaken) {
            // 1. ÊñáÂ≠ó„Å™„ÅóÔºà„Éó„É¨„Éì„É•„ÉºÁî®Ôºâ„Çí‰øùÂ≠ò
            this.gameOverScreenshotURL = this.canvas.toDataURL('image/png');
            
            // 2. ÊñáÂ≠ó„ÅÇ„ÇäÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®Ôºâ„ÇíÁîüÊàê„Åó„Å¶‰øùÂ≠ò
            this.ctx.save();
            
            // ÂçäÈÄèÊòé„ÅÆÈªíËÉåÊôØ„ÇíÈáç„Å≠„Å¶ÊñáÂ≠ó„ÇíË¶ã„ÇÑ„Åô„Åè
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            this.ctx.fillRect(0, 0, this.width, this.height);

            this.ctx.fillStyle = '#FF4500';
            this.ctx.font = 'bold 48px "M PLUS Rounded 1c"';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.shadowColor = 'white';
            this.ctx.shadowBlur = 10;
            this.ctx.fillText("GAME OVER", this.width / 2, this.height / 2 - 80);
            this.ctx.shadowBlur = 0;

            this.ctx.fillStyle = 'white';
            this.ctx.font = 'bold 32px "M PLUS Rounded 1c"';
            this.ctx.fillText(`Ë®òÈå≤: ${Math.floor(this.score)}m`, this.width / 2, this.height / 2);

            this.ctx.fillStyle = '#FFD700';
            this.ctx.font = 'bold 24px "M PLUS Rounded 1c"';
            this.ctx.fillText(`Áß∞Âè∑: ${this.getRank(this.score)}`, this.width / 2, this.height / 2 + 40);

            this.ctx.fillStyle = '#FF6F61';
            this.ctx.font = 'bold 20px "M PLUS Rounded 1c"';
            this.ctx.fillText(`Ê≠ªÂõ†: ${reason || this.deathReason}`, this.width / 2, this.height / 2 + 80);

            this.ctx.restore();
            this.gameOverResultURL = this.canvas.toDataURL('image/png');
            
            // 3. ÁîªÈù¢„ÇíÂÖÉ„Å´Êàª„ÅôÔºàÂÜçÊèèÁîªÔºâ
            this.draw();
            
            this.screenshotTaken = true;
        }

        // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÁîüÊàê
        document.getElementById('screenshot').src = this.gameOverScreenshotURL;

        this.sound.stopBGM();
        this.uiReplay.style.display = 'none'; // „Çπ„Ç≠„ÉÉ„Éó„Éú„Çø„É≥„ÇíÈö†„Åô
        this.uiFinalScore.innerText = Math.floor(this.score);
        this.uiRank.innerText = `Áß∞Âè∑: ${this.getRank(this.score)}`;
        this.uiDeathReason.innerText = reason || this.deathReason;
        
        // „É™„Éó„É¨„Ç§„Éú„Çø„É≥„ÅÆË°®Á§∫Âà∂Âæ°Ôºà„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
        if (this.replayBuffer.length > 0) {
            this.btnReplay.style.display = 'block';
        } else {
            this.btnReplay.style.display = 'none';
        }

        if (this.score > this.highScore) {
            this.highScore = Math.floor(this.score);
            localStorage.setItem('ebi_highscore', this.highScore);
            this.uiHighScore.innerText = this.highScore;
        }
        this.frameCount = 0; // „É™„Çπ„Çø„Éº„ÉàÂæÖ„Å°ÊôÇÈñìÁî®
    }

    spawnEnemy() {
        // „Éú„ÇπÂá∫Áèæ‰∏≠„ÅØÈõëÈ≠öÊïµ„ÇíÂá∫„Åï„Å™„ÅÑ
        if (this.uiWarning.classList.contains('active') || this.enemies.some(e => e instanceof Whale)) {
            return;
        }

        // Èõ£ÊòìÂ∫¶Ë™øÊï¥: ÊôÇÈñìÁµåÈÅé„ÅßÂá∫ÁèæÈ†ªÂ∫¶„Åå‰∏ä„Åå„Çã
        // Ë∑ùÈõ¢„ÅåÈÄ≤„ÇÄ„Å´„Å§„Çå„Å¶ÈöúÂÆ≥Áâ©„ÅÆÈöôÈñì„ÇíÁã≠„Åè„Åô„ÇãÔºàÂá∫ÁèæÈ†ªÂ∫¶„Ç¢„ÉÉ„ÉóÔºâ
        let baseRate = 90;
        let minRate = 25;
        
        if (this.difficulty === 'EASY') {
            baseRate = 100;
            minRate = 35;
        } else if (this.difficulty === 'HARD') {
            baseRate = 45;
            minRate = 12;
        } else {
            baseRate = 70;
            minRate = 20;
        }

        const spawnRate = Math.max(minRate, baseRate - Math.floor(this.score / 25));
        
        if (this.frameCount % spawnRate === 0) {
            const type = Math.random();
            const isDeep = this.score > 1000; // 1000mË∂Ö„Åà„Åü„ÇâÊ∑±Êµ∑
            
            // Â≤©„ÅÆ‰∏ä„Å´Êïµ„ÇíÈÖçÁΩÆ„Åß„Åç„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            // ÁîªÈù¢Âè≥Á´Ø‰ªòËøë„Å´„ÅÇ„ÇãÂ≤©„ÇíÊé¢„Åô
            const rock = this.decorations.find(d => d instanceof RuggedTerrain && d.x > this.width - 100 && d.x < this.width + 200);

            // Ê∑±Êµ∑„Å™„Çâ‰∏ÄÂÆöÁ¢∫Áéá„ÅßÊèêÁÅØÈÆüÈ±á
            if (isDeep && Math.random() < 0.3) {
                this.enemies.push(new Anglerfish(this.width, Math.random() * (this.height - 100) + 50));
            } else if (rock && Math.random() < 0.5) {
                // Â≤©„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈ´òÁ¢∫Áéá„ÅßÂ≤©„ÅÆ‰∏ä„Å´Êïµ„ÇíÈÖçÁΩÆ
                // Â≤©„ÅÆ‰∏ä„ÅÆ„É©„É≥„ÉÄ„É†„Å™È†ÇÁÇπ„ÇíÈÅ∏Êäû
                const pointIndex = Math.floor(Math.random() * (rock.points.length - 2)) + 1;
                const p = rock.points[pointIndex];
                const enemyX = rock.x + p.x;
                const enemyY = rock.y + p.y;
                if (Math.random() < 0.5) {
                    this.enemies.push(new SeaAnemone(enemyX, enemyY));
                } else {
                    this.enemies.push(new Starfish(enemyX, enemyY));
                }
            } else if (type < 0.20) {
                // È≠ö (20%)
                this.enemies.push(new Fish(this.width, Math.random() * (this.height - 100) + 50));
            } else if (type < 0.35) {
                // „Ç§„ÉØ„Ç∑„ÅÆÁæ§„Çå (15%)
                const baseY = Math.random() * (this.height - 150) + 50;
                const count = Math.floor(Math.random() * 6) + 10; // 10~15Âåπ
                for(let i=0; i<count; i++) {
                    this.enemies.push(new Sardine(this.width + Math.random() * 200, baseY + Math.random()*80 - 40));
                }
            } else if (type < 0.45) {
                // „Éû„Ç∞„É≠ (10%) - Áõ¥ÈÄ≤È´òÈÄü
                this.enemies.push(new Tuna(this.width, Math.random() * (this.height - 100) + 50));
            } else if (type < 0.50) {
                // „Çµ„É° (5%) - „Éõ„Éº„Éü„É≥„Ç∞
                this.enemies.push(new Shark(this.width, Math.random() * (this.height - 100) + 50, this.player));
            } else if (type < 0.60) {
                // Á∂≤ (10%)
                this.enemies.push(new Net(this.width, Math.random() * (this.height - 200) + 100));
            } else if (type < 0.70) {
                // Èá£„ÇäÈáù (10%)
                this.enemies.push(new Hook(this.width, -100));
            } else if (type < 0.80) {
                // „Ç§„Ç´ (10%)
                this.enemies.push(new Squid(this.width, Math.random() * (this.height - 200) + 100));
            } else if (type < 0.85) {
                // „ÇØ„É©„Ç≤ (5%) - Êñ∞Ë¶è
                this.enemies.push(new Jellyfish(this.width, Math.random() * (this.height - 150) + 50));
            } else if (type < 0.90) {
                // „Çø„Ç≥ (5%)
                this.enemies.push(new Octopus(this.width, Math.random() * (this.height - 200) + 100));
            } else if (type < 0.93) {
                // „Éè„É™„Çª„É≥„Éú„É≥ (5%) - Êñ∞Ë¶è
                this.enemies.push(new Porcupinefish(this.width, Math.random() * (this.height - 100) + 50, this));
            } else if (type < 0.95) {
                // ÈõªÊ∞ó„Ç¶„Éä„ÇÆ (2%) - Êñ∞Ë¶è
                this.enemies.push(new ElectricEel(this.width, Math.random() * (this.height - 100) + 50, this.player));
            } else if (type < 0.97) {
                // „ÅÜ„Åö„Åó„Åä (3%) - ÁîªÈù¢‰∏äÈÉ®„Å´Âá∫Áèæ
                this.enemies.push(new Whirlpool(this.width, Math.random() * 80 + 40));
            } else if (type < 0.98) {
                // ÊΩú„ÇÄÈ≠ö (3%) - Êµ∑Â∫ï„Å´Âá∫Áèæ
                this.enemies.push(new Flatfish(this.width, this.height - 40));
            } else if (type < 0.995) {
                // „Ç´„Éã (2%) - Êµ∑Â∫ï„ÇíÊ≠©„Åè
                this.enemies.push(new Crab(this.width, this.getGroundY(this.width)));
            } else {
                // „ÅÜ„Å´ (2%) - Êµ∑Â∫ï„Å´ÈÖçÁΩÆ
                this.enemies.push(new SeaUrchin(this.width, this.height - 65));
            }
        }
    }

    showLevelUp() {
        this.uiLevelUp.classList.remove('animate');
        // Trigger reflow
        void this.uiLevelUp.offsetWidth;
        this.uiLevelUp.classList.add('animate');
    }

    spawnDecorations() {
        const groundY = this.getGroundY(this.width);

        // Êµ∑Â∫ï„ÅÆË£ÖÈ£æ („Çè„Åã„ÇÅ„ÄÅÂ≤©„ÄÅ„Çµ„É≥„Ç¥)
        if (this.frameCount % 30 === 0) { // Â≤©„Çæ„Éº„É≥„ÅÆ„Åü„ÇÅ„Å´Â∞ë„ÅóÈ†ªÂ∫¶„ÇíÊàª„Åô
            const rand = Math.random();
            if (rand < 0.6) {
                this.decorations.push(new Seaweed(this.width, groundY));
                // „Çè„Åã„ÇÅ„Å´Ê∑∑„Åò„Å£„Å¶„ÉÅ„É≥„Ç¢„Éä„Ç¥
                if (Math.random() < 0.1) { // Âá∫ÁèæÁéá„Çí‰∏ã„Åí„Çã
                    this.items.push(new GardenEel(this.width + 20, groundY));
                }
            } else if (rand < 0.85) { // Â≤©„ÅÆÁ¢∫Áéá„ÇíÂ∞ë„Åó‰∏ä„Åí„Çã
                this.decorations.push(new RuggedTerrain(this.width, this.height));
            } else {
                this.decorations.push(new Coral(this.width, groundY));
                // „Çµ„É≥„Ç¥Á§Å„Å´„Ç´„ÇØ„É¨„ÇØ„Éû„Éé„Éü
                if (Math.random() < 0.5) {
                    this.items.push(new Clownfish(this.width, this.height - 80));
                }
            }
        }
        // „Éë„Éº„É´ („Åü„Åæ„Å´)
        if (this.frameCount % 300 === 0) {
            // Êµ∑Â∫ï„Å´ÈÖçÁΩÆ
            this.items.push(new Pearl(this.width, groundY - 15));
        }
        // „Éó„É©„É≥„ÇØ„Éà„É≥ (È†ªÁπÅ„Å´)
        if (this.frameCount % 100 === 0) {
            this.items.push(new Plankton(this.width, Math.random() * (this.height - 100) + 50));
        }
        // ‰ª≤Èñì„Ç®„Éì („É¨„Ç¢)
        if (this.frameCount % 600 === 0) {
            this.items.push(new FriendShrimp(this.width, Math.random() * (this.height - 100) + 50));
        }
    }

    scatterItems(x, y) {
        // Â§ßÈáè„ÅÆ„Éë„Éº„É´ÔºàÈáçÂäõ„ÅßËêΩ„Å°„ÇãÔºâ
        for(let k=0; k<8; k++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 6 + 2;
            this.items.push(new Pearl(x, y, Math.cos(angle)*speed, Math.sin(angle)*speed));
        }
        // Â§ßÈáè„ÅÆ„Éó„É©„É≥„ÇØ„Éà„É≥Ôºà„Åµ„Çè„Åµ„ÇèÂ∫É„Åå„ÇãÔºâ
        for(let k=0; k<15; k++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 6 + 2;
            this.items.push(new Plankton(x, y, Math.cos(angle)*speed, Math.sin(angle)*speed));
        }
    }

    recordState() {
        // 2„Éï„É¨„Éº„É†„Å´1ÂõûË®òÈå≤
        if (this.frameCount % 2 !== 0) return;

        const snapshot = {
            player: {
                x: this.player.x, y: this.player.y, 
                angle: this.player.angle, isBending: this.player.isBending,
                lives: this.lives
            },
            scrollOffset: this.scrollOffset,
            score: this.score,
            objects: [],
            decorations: [] // Â≤©„ÅÆÂà§ÂÆöÁî®„Å´Âà•ÈÄî‰øùÂ≠ò
        };

        // ÊèèÁîª„Å´ÂøÖË¶Å„Å™„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
        const saveObj = (obj) => {
            const data = {
                type: obj.constructor.name,
                x: obj.x, y: obj.y,
                // ÂêÑ„ÇØ„É©„ÇπÂõ∫Êúâ„ÅÆÊèèÁîª„Éë„É©„É°„Éº„Çø
                angle: obj.angle,
                timer: obj.timer,
                moveTimer: obj.moveTimer,
                hasExploded: obj.hasExploded,
                width: obj.width, height: obj.height, // Rock, Seaweed
                color: obj.color, // Rock, Coral
                branches: obj.branches, // Coral
                life: obj.life, size: obj.size, isBackground: obj.isBackground, // Bubble
                length: obj.length // StreamLine
            };
            snapshot.objects.push(data);
        };

        this.decorations.forEach(saveObj);
        this.backgroundObjects.forEach(saveObj);
        this.items.forEach(saveObj);
        this.enemies.forEach(saveObj);
        this.particles.forEach(saveObj);
        this.streamLines.forEach(saveObj);
        snapshot.decorations = this.decorations.map(d => ({ type: d.constructor.name, x: d.x, y: d.y, width: d.width, height: d.height }));

        this.replayBuffer.push(snapshot);
        // „Éê„ÉÉ„Éï„Ç°Âà∂ÈôêÔºàÁ¥Ñ10ÁßíÂàÜ = 30fps * 10s = 300„Éï„É¨„Éº„É†Ôºâ
        if (this.replayBuffer.length > 300) {
            this.replayBuffer.shift();
        }
    }

    update() {
        if (this.state === STATE.REPLAY) {
            this.replayIndex++;
            if (this.replayIndex >= this.replayBuffer.length) {
                // „É™„Éó„É¨„Ç§ÁµÇ‰∫Ü
                this.gameOver(this.deathReason);
            }
            return;
        }

        if (this.state !== STATE.PLAYING) {
            if (this.state === STATE.GAMEOVER) this.frameCount++;
            return;
        }

        this.frameCount++;
        this.score += 0.1; // Ë∑ùÈõ¢Âä†ÁÆó
        this.scrollOffset += this.scrollSpeed;
        this.uiScore.innerText = Math.floor(this.score);

        // Áä∂ÊÖãË®òÈå≤Ôºà„É™„Éó„É¨„Ç§Áî®Ôºâ
        this.recordState();

        // BGM„Éë„É©„É°„Éº„ÇøÊõ¥Êñ∞
        this.sound.setBGMParams(this.score, this.inRapidCurrentZone);

        // „Éú„ÇπÂá∫ÁèæÂà§ÂÆö
        if (this.score - this.lastBossDistance >= CONSTANTS.BOSS_INTERVAL) {
            this.lastBossDistance = Math.floor(this.score);
            // Ë≠¶ÂëäË°®Á§∫
            this.uiWarning.classList.add('active');
            
            // 3ÁßíÂæå„Å´„Éú„ÇπÂá∫Áèæ
            setTimeout(() => {
                this.uiWarning.classList.remove('active');
                if (this.state === STATE.PLAYING) {
                    this.enemies.push(new Whale(this.width, this.height / 2));
                }
            }, 3000);
        }

        // „Éí„É©„É°ÊºîÂá∫‰∏≠„ÅØÊõ¥Êñ∞ÂÅúÊ≠¢ÔºàÊºîÂá∫Áî®„Çø„Ç§„Éû„Éº„ÅÆ„ÅøÂãï„Åã„ÅôÔºâ
        if (this.state === STATE.BITTEN) return;

        // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂà§ÂÆö (100m„Åî„Å®)
        const currentLevel = Math.floor(this.score / 100);
        if (currentLevel > this.level) {
            this.level = currentLevel;
            this.uiLevel.innerText = this.level + 1;
            this.scrollSpeed += 0.5; // ÈÄüÂ∫¶„Ç¢„ÉÉ„Éó
            this.showLevelUp();
        }

        // ÊøÄÊµÅ„Çæ„Éº„É≥„ÅÆÂà∂Âæ°
        this.rapidCurrentTimer++;
        // Á¥Ñ20Áßí„Åî„Å®„Å´5ÁßíÈñìÊøÄÊµÅ„Å´„Åô„Çã
        // Èõ£ÊòìÂ∫¶„ÅåÈ´ò„ÅÑ„Åª„Å©È†ªÁπÅ„Å´
        const rapidCurrentInterval = this.difficulty === 'HARD' ? 800 : 1200;
        if (!this.isRapidCurrent && this.rapidCurrentTimer > rapidCurrentInterval) {
            if (Math.random() < 0.02) { // „É©„É≥„ÉÄ„É†ÊÄß„ÇíÊåÅ„Åü„Åõ„Çã
                this.isRapidCurrent = true;
                this.rapidCurrentTimer = 0;
                // ÊøÄÊµÅ„ÅÆÈ´ò„Åï„ÇíÊ±∫ÂÆö (ÁîªÈù¢„ÅÆ20%„Äú80%„ÅÆÁØÑÂõ≤)
                this.rapidCurrentY = this.height * 0.2 + Math.random() * (this.height * 0.6);
                this.addFloatingText(this.width / 2, this.height / 2, "ÊøÄÊµÅÊ≥®ÊÑèÔºÅ", "#FF4500");
            }
        } else if (this.isRapidCurrent) {
            if (this.rapidCurrentTimer > 300) {
                this.isRapidCurrent = false;
                this.inRapidCurrentZone = false;
                this.rapidCurrentTimer = 0;
            }
            
            // „Éó„É¨„Ç§„É§„Éº„ÅåÊøÄÊµÅ„Çæ„Éº„É≥Ôºà‰∏ä‰∏ã100pxÔºâ„Å´„ÅÑ„Çã„ÅãÂà§ÂÆö
            const range = 100;
            this.inRapidCurrentZone = Math.abs(this.player.y - this.rapidCurrentY) < range;
            
            if (this.inRapidCurrentZone) {
                this.player.vx -= 0.3; // ÊµÅ„Åï„Çå„ÇãÂäõ„Çí„Åï„Çâ„Å´Âº∑„Åè
                // ÊøÄÊµÅÈü≥ÔºàÈ†ªÂ∫¶„Ç¢„ÉÉ„Éó„ÉªÈü≥Èáè„Ç¢„ÉÉ„ÉóÔºâ
                if (this.frameCount % 4 === 0) this.sound.playNoise(0.25);
            } else {
                // „Çæ„Éº„É≥Â§ñ„Åß„ÇÇÂ∞ë„ÅóÈü≥„ÅØ„Åô„Çã
                if (this.frameCount % 20 === 0) this.sound.playNoise(0.05);
            }
        }

        // „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
        this.player.update(this);

        // ÁîªÈù¢Â∑¶Á´Ø„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÂà§ÂÆö
        if (this.player.x < -this.player.radius) {
            this.lives = 0;
            this.gameOver("Ê≥¢„Å´È£≤„Åæ„Çå„Åü"); // ÁÑ°ÊïµÊôÇÈñì„ÇíÁÑ°Ë¶ñ„Åó„Å¶Âç≥„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
            return;
        }

        // ÊïµÁîüÊàê„Å®Êõ¥Êñ∞
        this.spawnEnemy();
        this.spawnBackgroundObjects();
        this.spawnDecorations();
        
        for (let i = this.enemies.length - 1; i >= 0; i--) {
            const enemy = this.enemies[i];
            enemy.update(this.scrollSpeed, this); // Hook„ÅÆ„Åü„ÇÅ„Å´this(game)„ÇíÊ∏°„Åô

            // ÂÆâÂÖ®Á≠ñ: Â∫ßÊ®ô„ÅåNaN„Å´„Å™„Å£„ÅüÊïµ„ÅØÂâäÈô§Ôºà„Éï„É™„Éº„Ç∫Èò≤Ê≠¢Ôºâ
            if (!isFinite(enemy.x) || !isFinite(enemy.y)) {
                this.enemies.splice(i, 1);
                continue;
            }

            // ÁîªÈù¢Â§ñÂà§ÂÆö
            if (enemy.isOffScreen(this.width, this.height)) {
                this.enemies.splice(i, 1);
                continue;
            }

            // ÂΩì„Åü„ÇäÂà§ÂÆö
            if (enemy.checkCollision(this.player)) {
                if (enemy instanceof Flatfish) {
                    // „Éí„É©„É°„ÅØÂç≥Ê≠ªÊºîÂá∫
                    this.triggerFlatfishDeath(enemy);
                } else {
                    let reason = "Êïµ„Å´„Å∂„Å§„Åã„Å£„Åü";
                    if (enemy instanceof Fish) reason = "È≠ö„Å´„Å∂„Å§„Åã„Å£„Åü";
                    else if (enemy instanceof Sardine) reason = "„Ç§„ÉØ„Ç∑„ÅÆÁæ§„Çå„Å´Â∑ª„ÅçËæº„Åæ„Çå„Åü";
                    else if (enemy instanceof Tuna) reason = "„Éû„Ç∞„É≠„Å´ÊøÄÁ™Å„Åï„Çå„Åü";
                    else if (enemy instanceof Hook) reason = "Èá£„ÇäÈáù„Å´Âºï„Å£„Åã„Åã„Å£„Åü";
                    else if (enemy instanceof Anglerfish) reason = "ÊèêÁÅØÈÆüÈ±á„Å´È£ü„Åπ„Çâ„Çå„Åü";
                    else if (enemy instanceof Shark) reason = "„Çµ„É°„Å´Âôõ„Åæ„Çå„Åü";
                    else if (enemy instanceof Net) reason = "Á∂≤„Å´Êçï„Åæ„Å£„Åü";
                    else if (enemy instanceof Squid) reason = "„Ç§„Ç´„Å´„Å∂„Å§„Åã„Å£„Åü";
                    else if (enemy instanceof Octopus) reason = "„Çø„Ç≥„Å´Êçï„Åæ„Å£„Åü";
                    else if (enemy instanceof Jellyfish) reason = "„ÇØ„É©„Ç≤„Å´Âà∫„Åï„Çå„Åü";
                    else if (enemy instanceof Porcupinefish || enemy instanceof Needle) reason = "„Éè„É™„Çª„É≥„Éú„É≥„ÅÆÈáù„ÅåÂà∫„Åï„Å£„Åü";
                    else if (enemy instanceof Whirlpool) reason = "„ÅÜ„Åö„Åó„Åä„Å´Â∑ª„ÅçËæº„Åæ„Çå„Åü";
                    else if (enemy instanceof Whale) reason = "Â∑®Â§ß„ÇØ„Ç∏„É©„Å´Ë°ùÁ™Å„Åó„Åü";
                    else if (enemy instanceof WaterSpout || enemy instanceof WaterDrop) reason = "„ÇØ„Ç∏„É©„ÅÆÊΩÆÂêπ„Åç„Å´„ÇÑ„Çâ„Çå„Åü";
                    else if (enemy instanceof SeaUrchin) reason = "„ÅÜ„Å´„Å´Âà∫„Åï„Å£„Åü";
                    else if (enemy instanceof Crab) reason = "„Ç´„Éã„Å´Êåü„Åæ„Çå„Åü";
                    else if (enemy instanceof SeaAnemone) reason = "„Ç§„ÇΩ„ÇÆ„É≥„ÉÅ„É£„ÇØ„Å´Âà∫„Åï„Çå„Åü";
                    else if (enemy instanceof Starfish) reason = "„Éí„Éà„Éá„Å´Âºµ„Çä‰ªò„Åã„Çå„Åü";
                    else if (enemy instanceof ElectricEel) reason = "ÈõªÊ∞ó„Ç¶„Éä„ÇÆ„Å´ÊÑüÈõª„Åó„Åü";
                    this.hitPlayer(reason);
                }
            }
        }

        // „Ç¢„Ç§„ÉÜ„É†Êõ¥Êñ∞
        for (let i = this.items.length - 1; i >= 0; i--) {
            const item = this.items[i];
            item.update(this.scrollSpeed, this); // game„ÇíÊ∏°„Åô
            
            // ÂÆâÂÖ®Á≠ñ
            if (!isFinite(item.x) || !isFinite(item.y)) {
                this.items.splice(i, 1);
                continue;
            }

            if (item.isOffScreen(this.width, this.height)) {
                this.items.splice(i, 1);
                continue;
            }
            
            if (item.checkCollision(this.player)) {
                this.sound.playItem();
                if (item instanceof Pearl) {
                    this.score += 50;
                    this.addFloatingText(item.x, item.y, "+50", "#FFD700");
                } else if (item instanceof TreasureChest) {
                    this.score += 500;
                    this.addFloatingText(item.x, item.y, "+500", "#FFD700");
                } else if (item instanceof FriendShrimp) { // Plankton„Çà„ÇäÂÖà„Å´Âà§ÂÆö„Åô„Çã
                    if (this.lives < CONSTANTS.MAX_LIVES) {
                        this.lives++;
                        this.updateLifeDisplay();
                        this.updatePlayerSize();
                        this.addFloatingText(item.x, item.y, "1UP!", "#FF69B4");
                    } else {
                        // „É©„Ç§„ÉïÊ∫Ä„Çø„É≥„Å™„Çâ„Çπ„Ç≥„Ç¢„Éú„Éº„Éä„Çπ
                        this.score += 100;
                        this.addFloatingText(item.x, item.y, "+100", "#FFD700");
                    }
                } else if (item instanceof Plankton) {
                    this.score += 10;
                    this.addFloatingText(item.x, item.y, "+10", "#90EE90");
                } else if (item instanceof Clownfish) {
                    this.score += 50;
                    this.addFloatingText(item.x, item.y, "+50", "#FF4500");
                } else if (item instanceof GardenEel) {
                    this.score += 30;
                    this.addFloatingText(item.x, item.y, "+30", "#FFFFFF");
                }
                this.items.splice(i, 1);
            }
        }

        // Ë£ÖÈ£æÊõ¥Êñ∞
        for (let i = this.decorations.length - 1; i >= 0; i--) {
            const deco = this.decorations[i];
            deco.update(this.scrollSpeed, this);
            
            // ÁîªÈù¢Â§ñÂà§ÂÆö‰øÆÊ≠£: Â≤©„Å™„Å©„ÅåÂÆåÂÖ®„Å´Ê∂à„Åà„Å¶„Åã„ÇâÂâäÈô§
            const offscreenX = deco.width ? deco.x + deco.width : deco.x;
            if (offscreenX < 0) this.decorations.splice(i, 1);

            // Â≤©„ÅÆÂΩì„Åü„ÇäÂà§ÂÆö„ÅØShrimp.update„Å´ÁßªÂãï
        }

        // ËÉåÊôØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊõ¥Êñ∞
        for (let i = this.backgroundObjects.length - 1; i >= 0; i--) {
            const obj = this.backgroundObjects[i];
            obj.update(this.scrollSpeed);
            if (obj.x < -300) this.backgroundObjects.splice(i, 1);
        }

        // ÊøÄÊµÅ„Ç®„Éï„Çß„ÇØ„ÉàÔºà„Çπ„Éà„É™„Éº„É†„É©„Ç§„É≥Ôºâ
        if (this.isRapidCurrent && this.frameCount % 2 === 0) {
            // ÊøÄÊµÅ„ÅÆÈ´ò„ÅïÂë®Ëæ∫„Å´ÁîüÊàê
            const y = this.rapidCurrentY + (Math.random() - 0.5) * 200;
            this.streamLines.push(new StreamLine(this.width, y));
        }
        for (let i = this.streamLines.length - 1; i >= 0; i--) {
            // ÊøÄÊµÅÊôÇ„ÅØ„Çπ„ÇØ„É≠„Éº„É´„ÇÇÈÄü„ÅèË¶ã„Åà„Çã„Çà„ÅÜ„Å´
            this.streamLines[i].update(this.scrollSpeed + 10);
            if (this.streamLines[i].x < -200) this.streamLines.splice(i, 1);
        }

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÔºàÊ≥°Ôºâ
        if (this.frameCount % 20 === 0) {
            this.particles.push(new Bubble(this.player.x, this.player.y));
            if (Math.random() < 0.05) this.sound.playBubble(); // „Åü„Åæ„Å´Èü≥„ÇíÈ≥¥„Çâ„Åô
        }

        // ËÉåÊôØ„ÅÆÊ≥°Ôºà„Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Å¶Â¢ó„Åà„ÇãÊºîÂá∫Ôºâ
        // Ê∑±Â∫¶(score)„Å´Âøú„Åò„Å¶Áô∫ÁîüÁ¢∫Áéá„Å®Êï∞„Çí‰∏ä„Åí„Çã
        const bubbleDensity = Math.min(20, Math.floor(this.score / 300)); 
        if (this.frameCount % 15 === 0) {
            // Âü∫Êú¨Á¢∫Áéá + „Çπ„Ç≥„Ç¢„Éú„Éº„Éä„Çπ
            if (Math.random() < 0.2 + (bubbleDensity * 0.05)) {
                // ÁîªÈù¢‰∏ãÈÉ®„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´Áô∫Áîü
                this.particles.push(new Bubble(Math.random() * (this.width + 100), this.height + 10, true));
            }
        }

        for (let i = this.particles.length - 1; i >= 0; i--) {
            this.particles[i].update(this.scrollSpeed);
            if (this.particles[i].life <= 0) this.particles.splice(i, 1);
        }

        // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
        for (let i = this.floatingTexts.length - 1; i >= 0; i--) {
            this.floatingTexts[i].update();
            if (this.floatingTexts[i].life <= 0) this.floatingTexts.splice(i, 1);
        }
    }

    spawnBackgroundObjects() {
        // Ê≤àÊ≤°Ëàπ („Åü„Åæ„Å´)
        if (this.frameCount % 1200 === 0) {
            const x = this.width;
            const y = this.height - 50;
            this.backgroundObjects.push(new Shipwreck(x, y));
            // ÂÆùÁÆ±„ÇíÊ≤àÊ≤°Ëàπ„ÅÆËøë„ÅèÔºàÊµ∑Â∫ïÔºâ„Å´ÈÖçÁΩÆ
            this.items.push(new TreasureChest(x + 100, this.getGroundY(x + 100)));
        }
    }

    draw() {
        if (this.state === STATE.REPLAY) {
            this.drawReplay();
            return;
        }

        // „Éí„É©„É°ÊçïÈ£üÊºîÂá∫‰∏≠„ÅÆÊèèÁîª
        if (this.state === STATE.BITTEN) {
            this.bittenTimer++;
            
            // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØÊºîÂá∫
            const shakeX = (Math.random() - 0.5) * 20;
            const shakeY = (Math.random() - 0.5) * 20;
            this.ctx.save();
            this.ctx.translate(shakeX, shakeY);

            // ËÉåÊôØ„Å™„Å©„ÅØ„Åù„ÅÆ„Åæ„Åæ
            // „Éí„É©„É°„ÇíÊèèÁîªÔºàÂè£„ÇíÈñâ„Åò„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Å™„Å©Ôºâ
            this.killerEnemy.draw(this.ctx, true); // true = ÊçïÈ£ü‰∏≠
            
            this.ctx.restore();

            // ‰∏ÄÂÆöÊôÇÈñìÂæå„Å´„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
            if (this.bittenTimer > 60) {
                this.gameOver();
            }
            return;
        }

        // ËÉåÊôØ„ÇØ„É™„Ç¢
        // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Å¶ËÉåÊôØËâ≤„ÇíÊ∑±Êµ∑ÔºàÊöó„ÅèÔºâ„Å´„Åô„ÇãÊºîÂá∫
        const maxDepth = 2000; // 2000m„ÅßÊúÄ„ÇÇÊöó„Åè„Å™„Çã
        const ratio = Math.min(this.score / maxDepth, 1);
        
        // #87CEEB (135, 206, 235) -> #001020 (0, 16, 32)
        const r = Math.floor(135 * (1 - ratio) + 0 * ratio);
        const g = Math.floor(206 * (1 - ratio) + 16 * ratio);
        const b = Math.floor(235 * (1 - ratio) + 32 * ratio);

        // ËÉåÊôØ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ (‰∏ä„Åã„ÇâÂÖâ„ÅåÂ∑Æ„ÅóËæº„ÇÄË°®Áèæ)
        const gradient = this.ctx.createLinearGradient(0, 0, 0, this.height);
        gradient.addColorStop(0, `rgb(${Math.min(255, r+30)},${Math.min(255, g+30)},${Math.min(255, b+30)})`);
        gradient.addColorStop(1, `rgb(${r},${g},${b})`);
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(0, 0, this.width, this.height);

        // ËÉåÊôØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊèèÁîªÔºàÂú∞Èù¢„Çà„ÇäÂ••Ôºâ
        this.backgroundObjects.forEach(o => o.draw(this.ctx));

        // Êµ∑Â∫ï„ÅÆÊèèÁîªÔºàÁ†ÇÔºâ
        // „ÅÜ„Å≠„ÅÜ„Å≠„Åï„Åõ„Çã
        this.ctx.fillStyle = '#E0C090'; // Á†Ç„Å£„ÅΩ„ÅÑËâ≤
        this.ctx.beginPath();
        this.ctx.moveTo(0, this.height);
        for (let x = 0; x <= this.width; x += 10) {
            this.ctx.lineTo(x, this.getGroundY(x));
        }
        this.ctx.lineTo(this.width, this.height);
        this.ctx.fill();

        // ÊøÄÊµÅ„Ç®„Éï„Çß„ÇØ„ÉàÊèèÁîª
        this.streamLines.forEach(l => l.draw(this.ctx));
        if (this.isRapidCurrent) {
            // ÊøÄÊµÅ„Çæ„Éº„É≥„ÇíÂèØË¶ñÂåñÔºàËñÑ„ÅÑÂ∏ØÔºâ
            const grad = this.ctx.createLinearGradient(0, this.rapidCurrentY - 100, 0, this.rapidCurrentY + 100);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0)');
            grad.addColorStop(0.5, 'rgba(255, 255, 255, 0.15)');
            grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
            this.ctx.fillStyle = grad;
            this.ctx.fillRect(0, this.rapidCurrentY - 100, this.width, 200);
        }

        // „Ç¢„Ç§„ÉÜ„É†ÊèèÁîª
        this.items.forEach(i => i.draw(this.ctx));

        // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„ÉàÊèèÁîª
        this.floatingTexts.forEach(t => t.draw(this.ctx));

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊèèÁîª
        this.particles.forEach(p => p.draw(this.ctx));

        // ÊïµÊèèÁîª
        this.enemies.forEach(e => e.draw(this.ctx));

        // Ë£ÖÈ£æÊèèÁîª
        this.decorations.forEach(d => d.draw(this.ctx, this.frameCount));

        // „Éó„É¨„Ç§„É§„ÉºÊèèÁîª
        this.player.draw(this.ctx, this.lives, this.decorations);
    }

    drawReplay() {
        const snapshot = this.replayBuffer[this.replayIndex];
        if (!snapshot) return;

        // ËÉåÊôØÊèèÁîªÔºàÂÖ±ÈÄöÂá¶ÁêÜ„ÅÆ‰∏ÄÈÉ®ÂÜçÂà©Áî®Ôºâ
        const maxDepth = 2000;
        const ratio = Math.min(snapshot.score / maxDepth, 1);
        const r = Math.floor(135 * (1 - ratio) + 0 * ratio);
        const g = Math.floor(206 * (1 - ratio) + 16 * ratio);
        const b = Math.floor(235 * (1 - ratio) + 32 * ratio);
        const gradient = this.ctx.createLinearGradient(0, 0, 0, this.height);
        gradient.addColorStop(0, `rgb(${Math.min(255, r+30)},${Math.min(255, g+30)},${Math.min(255, b+30)})`);
        gradient.addColorStop(1, `rgb(${r},${g},${b})`);
        this.ctx.fillStyle = gradient;
        this.ctx.fillRect(0, 0, this.width, this.height);

        // Âú∞Èù¢
        this.ctx.fillStyle = '#E0C090';
        this.ctx.beginPath();
        this.ctx.moveTo(0, this.height);
        // Âú∞Èù¢„ÅÆ„ÅÜ„Å≠„Çä„ÅØscrollOffset„Å´‰æùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÄÅsnapshot„ÅÆÂÄ§„Çí‰ΩøÁî®
        const getGroundY = (x) => {
            const base = this.height - 50;
            return base + Math.sin((x + snapshot.scrollOffset) * 0.005) * 20 + Math.sin((x + snapshot.scrollOffset) * 0.02) * 10;
        };
        for (let x = 0; x <= this.width; x += 10) {
            this.ctx.lineTo(x, getGroundY(x));
        }
        this.ctx.lineTo(this.width, this.height);
        this.ctx.fill();

        // ËÉåÊôØ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊèèÁîªÔºà„É™„Éó„É¨„Ç§Ôºâ
        // snapshot.objects„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅÈÄöÂ∏∏„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊèèÁîª„É´„Éº„Éó„ÅßÂá¶ÁêÜ„Åï„Çå„Çã„ÅØ„Åö„Å†„Åå„ÄÅ
        // ÊèèÁîªÈ†ÜÂ∫è„ÇíÂÆà„Çã„Åü„ÇÅ„Å´„ÄÅtype„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åó„Å¶ÂÖà„Å´ÊèèÁîª„Åô„Çã„ÅÆ„ÅåÁêÜÊÉ≥„ÄÇ
        // Á∞°ÊòìÁöÑ„Å´„ÄÅËÉåÊôØ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇØ„É©„Çπ„Å™„ÇâÂÖà„Å´ÊèèÁîª„Åô„Çã„Çà„ÅÜ„Å´„ÇΩ„Éº„Éà„Åô„Çã„Åã„ÄÅ2Âõû„É´„Éº„Éó„Åô„Çã„ÄÇ
        
        // ËÉåÊôØ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ„ÅøÂÖà„Å´ÊèèÁîª
        snapshot.objects.forEach(data => {
            if (data.type === 'Shipwreck') {
                const dummy = this.replayDummies[data.type];
                if (dummy) {
                    Object.assign(dummy, data);
                    dummy.draw(this.ctx, this.frameCount);
                }
            }
        });

        // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÊèèÁîª
        snapshot.objects.forEach(data => {
            if (data.type === 'Shipwreck') return; // ÊèèÁîªÊ∏à„Åø
            const dummy = this.replayDummies[data.type];
            if (dummy) {
                Object.assign(dummy, data); // „Éó„É≠„Éë„ÉÜ„Ç£„Çí„Ç≥„Éî„Éº
                dummy.draw(this.ctx, this.frameCount); // frameCount„ÅØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„Å†„Åå„ÄÅ„É™„Éó„É¨„Ç§„Åß„ÅØÈÄ≤Ë°å„ÅóÁ∂ö„Åë„ÇãÂÄ§„Åß‰ª£Áî®
            }
        });

        // „Éó„É¨„Ç§„É§„ÉºÊèèÁîª
        const pData = snapshot.player;
        const pDummy = this.replayDummies['Shrimp'];
        Object.assign(pDummy, pData);
        
        // ‰ª≤Èñì„Ç®„Éì„ÅÆÊèèÁîªÔºàÂ±•Ê≠¥„Åã„ÇâÂæ©ÂÖÉÔºâ
        // „É™„Éó„É¨„Ç§„Éê„ÉÉ„Éï„Ç°Ëá™‰Ωì„ÇíÂ±•Ê≠¥„Å®„Åó„Å¶‰Ωø„ÅÜ
        const followerCount = Math.max(0, pData.lives - 1);

        for (let i = 1; i <= followerCount; i++) {
            // 2„Éï„É¨„Éº„É†„Å´1ÂõûË®òÈå≤„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅÈÅÖÂª∂„Éï„É¨„Éº„É†Êï∞(8) / 2 = 4„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂâç„ÇíÂèÇÁÖß
            const delayIdx = i * 4;
            const prevSnapshot = this.replayBuffer[this.replayIndex - delayIdx];
            if (prevSnapshot) pDummy.drawFollower(this.ctx, prevSnapshot.player);
        }
        // Êú¨‰ΩìÊèèÁîª
        Object.assign(pDummy, pData); // Êàª„Åô
        pDummy.draw(this.ctx, pData.lives, snapshot.decorations.map(d => Object.assign(this.replayDummies[d.type], d)));

        // UI
        this.ctx.fillStyle = 'white';
        this.ctx.font = '20px sans-serif';
        this.ctx.fillText("REPLAY", 20, 80);
    }
    
    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(this.loop);
    }
}

/**
 * „Ç≠„É£„É©„ÇØ„Çø„Éº„ÇØ„É©„Çπ: „Åà„Å≥„Å°„ÇÉ„Çì
 */
class Shrimp {
    constructor(x, y) {
        this.reset(x, y);
        this.radius = CONSTANTS.SHRIMP_BASE_SIZE;
    }

    reset(x, y) {
        this.x = x;
        this.y = y;
        this.vx = 0;
        this.vy = 0;
        this.angle = 0;
        this.isBending = false; // „Åè„ÅÆÂ≠óÁä∂ÊÖã
        this.invincibleTimer = 0;
        this.bendTimer = 0;
        this.history = []; // ËªåË∑°‰øùÂ≠òÁî®
        this.recoveryBoostTimer = 0;
    }

    jump() {
        // ‰ªïÊßò: ÂæåÊñπÔºã‰∏äÊñπÂêë„Å∏Ë∑≥„Å≠„Çã
        this.vy = CONSTANTS.JUMP_FORCE_Y;
        this.vx = CONSTANTS.JUMP_FORCE_X;
        this.isBending = true;
        this.bendTimer = 15; // Â§âÂΩ¢ÊåÅÁ∂ö„Éï„É¨„Éº„É†
        this.recoveryBoostTimer = 30; // Ê≥≥„Åé„Éñ„Éº„Çπ„Éà
    }

    setInvincible(frames) {
        this.invincibleTimer = frames;
    }

    update(game) {
        const screenWidth = game.width;

        // ÈáçÂäõÔºàÂæê„ÄÖ„Å´Ê≤à„ÇÄÔºâ
        this.vy += CONSTANTS.GRAVITY;

        if (this.recoveryBoostTimer > 0) this.recoveryBoostTimer--;
        const recoveryForce = (this.recoveryBoostTimer > 0) ? 0.35 : 0.2;
        
        // Ëá™ÂãïÂâçÈÄ≤ÔºàÂÖÉ„ÅÆ‰ΩçÁΩÆ„Å´Êàª„Çç„ÅÜ„Å®„Åô„ÇãÂäõÔºâ
        // ÁîªÈù¢Â∑¶Á´Ø„Å´Ë°å„ÅçÈÅé„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´„ÄÅÂè≥ÊñπÂêë„Å∏‰∏ÄÂÆö„ÅÆÂäõ„Çí„Åã„Åë„Çã
        if (this.x < this.radius * 4) {
            this.vx -= 0.5; // Â∑¶Á´Ø„Å´Ëøë„Å•„Åè„Å®Â§ñÂÅ¥„Å´Âê∏„ÅÑËæº„Åæ„Çå„ÇãÔºàÂæ©Â∏∞Âõ∞Èõ£„Å´Ôºâ
        } else if (this.x < screenWidth * 0.3) {
            this.vx += recoveryForce; // È†ëÂºµ„Å£„Å¶Ê≥≥„Åê„Å®Âæ©Â∏∞Âäõ„Ç¢„ÉÉ„Éó
        } else {
            // ÂÆö‰ΩçÁΩÆ„Çà„ÇäÂâç„Å´Âá∫ÈÅé„Åé„Å™„ÅÑ„Çà„ÅÜ„Å´Ê∏õÈÄü
            this.vx *= 0.95;
        }

        // ÈÄüÂ∫¶ÈÅ©Áî®
        this.x += this.vx;
        this.y += this.vy;

        // ÁîªÈù¢Á´ØÂà∂Èôê
        // Â§©‰∫ï
        if (this.y < this.radius) { this.y = this.radius; this.vy = 0; } // Â§©‰∫ï
        
        // Âú∞Èù¢ÔºàÊµ∑Â∫ï„ÉªÂ≤©Ôºâ„Å®„ÅÆÂΩì„Åü„ÇäÂà§ÂÆö
        let groundY = game.getGroundY(this.x);
        const rocks = game.decorations.filter(d => d instanceof RuggedTerrain);
        for (const rock of rocks) {
            // „Éó„É¨„Ç§„É§„Éº„ÅåÂ≤©„ÅÆÊ∞¥Âπ≥ÁØÑÂõ≤ÂÜÖ„Å´„ÅÑ„Çã„Åã
            // Â≤©„ÅÆÂΩì„Åü„ÇäÂà§ÂÆö‰øÆÊ≠£: points„Çí‰Ωø„Å£„Å¶Ê≠£Á¢∫„Å™ÁØÑÂõ≤„ÇíÂèñÂæó
            const startX = rock.x + rock.points[0].x;
            const endX = rock.x + rock.points[rock.points.length - 1].x;
            if (this.x >= startX && this.x <= endX) {
                const surfaceInfo = rock.getSurfaceInfo(this.x);
                if (surfaceInfo) {
                    // 45Â∫¶‰ª•‰∏ã„ÅÆÂùÇÈÅì„Å™„ÇâÂú∞Èù¢„Å®„Åó„Å¶Ë™çË≠ò
                    if (Math.abs(surfaceInfo.slope) <= 1) {
                        if (surfaceInfo.y < groundY + 5) { // Â∞ë„Åó‰ΩôË£ï„ÇíÊåÅ„Åü„Åõ„Çã
                            groundY = surfaceInfo.y;
                        }
                    }
                    // 45Â∫¶„Çà„ÇäÊÄ•„Å™ÂùÇÔºàÂ£ÅÔºâ„Å´Ê®™„Åã„Çâ„Å∂„Å§„Åã„Å£„ÅüÂ†¥Âêà
                    else if (this.y + this.radius > surfaceInfo.y) {
                        // Âüã„Åæ„ÇäÂÖ∑Âêà„Åã„ÇâÊäº„ÅóÂá∫„ÅóÈáè„ÇíË®àÁÆó
                        const embed = (this.y + this.radius) - surfaceInfo.y;
                        const push = (embed + 2) / surfaceInfo.slope;
                        
                        if (surfaceInfo.slope < 0) {
                            // ‰∏ä„ÇäÂùÇÔºàÂ∑¶Â£ÅÔºâ: ÊúÄ‰Ωé„Åß„ÇÇ5px„ÅØÊäº„ÅóÊàª„ÅôÔºà„Åô„ÇäÊäú„ÅëÈò≤Ê≠¢Ôºâ
                            this.x += Math.min(push, -5);
                        } else {
                            // ‰∏ã„ÇäÂùÇÔºàÂè≥Â£ÅÔºâ
                            this.x += Math.max(push, 5);
                        }
                        this.vx *= -0.5; // Ë∑≥„Å≠Ëøî„Çã
                    }
                }
            }
            // Â≤©„ÅÆÂ∑¶Á´Ø„Å´Ë°ùÁ™Å„Åó„ÅüÂ†¥Âêà
            if (rock.checkSideCollision(this)) {
                this.x = rock.x - this.radius;
                this.vx = 0;
            }
        }
        if (this.y > groundY - this.radius) { // Âú∞Èù¢„Å´ÁùÄÂú∞
            this.y = groundY - this.radius;
            this.vy = 0;
        }
        
        // Âè≥Â£Å
        if (this.x > screenWidth - this.radius) this.x = screenWidth - this.radius; // Âè≥Â£Å

        // Â§âÂΩ¢„Çø„Ç§„Éû„Éº
        if (this.bendTimer > 0) {
            this.bendTimer--;
        } else {
            this.isBending = false;
        }

        // NaN„Ç¨„Éº„Éâ
        if (isNaN(this.x)) { this.x = 100; this.vx = 0; }
        if (isNaN(this.y)) { this.y = 100; this.vy = 0; }
        if (isNaN(this.vx)) this.vx = 0;
        if (isNaN(this.vy)) this.vy = 0;

        // Â±•Ê≠¥„ÅÆÊõ¥Êñ∞ÔºàËøΩÂæìÁî®Ôºâ
        this.history.unshift({x: this.x, y: this.y, angle: this.angle, isBending: this.isBending});
        if (this.history.length > 100) {
            this.history.pop();
        }
        
        if (this.invincibleTimer > 0) {
            this.invincibleTimer--;
        }

        // ËßíÂ∫¶Ë®àÁÆóÔºàÈÄ≤Ë°åÊñπÂêë„Å´Âêë„Åë„ÇãÔºâ
        // „Éê„ÉÉ„ÇØ‰∏≠„ÅØÂæå„ÇçÂêë„Åç„ÄÅÈÄöÂ∏∏„ÅØÂâçÂêë„Åç
        if (this.isBending) {
            this.angle = -Math.PI / 4; // „Éê„ÉÉ„ÇØÊôÇ„ÅÆËßíÂ∫¶
        } else {
            this.angle = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, this.vy * 0.1));
        }
    }
    
    get isInvincible() {
        return this.invincibleTimer > 0;
    }

    draw(ctx, lives = 1, decorations = []) {
        // ÁÑ°ÊïµÊôÇÈñì„ÅØÁÇπÊªÖ
        if (this.isInvincible && Math.floor(Date.now() / 100) % 2 === 0) return;

        // ‰ª≤ÈñìÔºàÊÆãÊ©üÂàÜÔºâ„ÅÆÊèèÁîª
        // Â±•Ê≠¥„Çí‰Ωø„Å£„Å¶Âæå„Çç„Çí„Å§„ÅÑ„Å¶„Åì„Åï„Åõ„Çã
        // 1Âåπ„ÅÇ„Åü„Çä10„Éï„É¨„Éº„É†ÈÅÖ„Çå„ÅßË°®Á§∫
        const followerCount = Math.max(0, lives - 1);
        for (let i = 1; i <= followerCount; i++) {
            const delay = i * 8;
            if (this.history[delay]) {
                const pos = this.history[delay];
                // ÂÆâÂÖ®Á≠ñ: Â±•Ê≠¥„Åå‰∏çÊ≠£„Å™Â†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                const followerDummy = { x: pos.x, y: pos.y, radius: this.radius * 0.7 };
                let inRock = false;
                if (decorations) {
                    inRock = decorations.some(d => d instanceof RuggedTerrain && d.checkSideCollision(followerDummy));
                }

                if (inRock) continue;

                if (!isFinite(pos.x) || !isFinite(pos.y)) continue;
                ctx.save();
                ctx.translate(pos.x, pos.y);
                ctx.rotate(pos.angle);
                // ‰ª≤Èñì„ÅØÂ∞ë„ÅóÂ∞è„Åï„Åè„ÄÅËâ≤„ÇíÂ§â„Åà„Çã
                const scale = 0.7;
                ctx.scale(scale, scale);
                // ‰ª≤Èñì„ÅÆËâ≤
                const fGrad = ctx.createRadialGradient(0, -this.radius*0.2, 0, 0, 0, this.radius);
                fGrad.addColorStop(0, '#FFC0CB');
                fGrad.addColorStop(1, '#FFB6C1');
                ctx.fillStyle = fGrad;
                this.drawBody(ctx, pos.isBending);
                ctx.restore();
            }
        }

        // ÂÆâÂÖ®Á≠ñ
        if (!isFinite(this.x) || !isFinite(this.y)) return;

        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);

        const grad = ctx.createRadialGradient(0, -this.radius*0.2, 0, 0, 0, this.radius);
        grad.addColorStop(0, '#FF8E84');
        grad.addColorStop(1, CONSTANTS.SHRIMP_COLOR);
        ctx.fillStyle = grad;
        
        this.drawBody(ctx, this.isBending);

        ctx.restore();
    }

    drawFollower(ctx, pos) {
        if (!isFinite(pos.x) || !isFinite(pos.y)) return;
        ctx.save();
        ctx.translate(pos.x, pos.y);
        ctx.rotate(pos.angle);
        // ‰ª≤Èñì„ÅØÂ∞ë„ÅóÂ∞è„Åï„Åè„ÄÅËâ≤„ÇíÂ§â„Åà„Çã
        const scale = 0.7;
        ctx.scale(scale, scale);
        // ‰ª≤Èñì„ÅÆËâ≤
        const fGrad = ctx.createRadialGradient(0, -this.radius*0.2, 0, 0, 0, this.radius);
        fGrad.addColorStop(0, '#FFC0CB');
        fGrad.addColorStop(1, '#FFB6C1');
        ctx.fillStyle = fGrad;
        this.drawBody(ctx, pos.isBending);
        ctx.restore();
    }

    drawBody(ctx, isBending) {
        const baseStyle = ctx.fillStyle;
        // „Çà„Çä„É™„Ç¢„É´„Åß„Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É•„Å™„Ç®„Éì„ÅÆ„Éá„Ç∂„Ç§„É≥
        if (isBending) {
            // „Åè„ÅÆÂ≠óÔºà„Ç∏„É£„É≥„ÉóÊôÇÔºâ
            ctx.beginPath();
            // ËÉ¥‰ΩìÔºàÊõ≤„Åå„Å£„Å¶„ÅÑ„ÇãÔºâ
            ctx.ellipse(0, 0, this.radius * 1.2, this.radius * 0.7, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Â∞ªÂ∞æ
            ctx.beginPath();
            ctx.moveTo(-this.radius * 0.8, 0);
            ctx.lineTo(-this.radius * 1.8, this.radius * 0.6);
            ctx.lineTo(-this.radius * 1.4, -this.radius * 0.2);
            ctx.fill();
        } else {
            // ÈÄöÂ∏∏Ôºà‰º∏„Å≥„Å¶„ÅÑ„ÇãÔºâ
            ctx.beginPath();
            // ËÉ¥‰Ωì
            ctx.ellipse(0, 0, this.radius * 1.6, this.radius * 0.6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ÁØÄÔºà„Çª„Ç∞„É°„É≥„ÉàÔºâ„ÅÆË°®Áèæ
            ctx.fillStyle = 'rgba(0,0,0,0.1)';
            for(let i=0; i<3; i++) {
                ctx.beginPath();
                ctx.arc(-this.radius * 0.5 + i * this.radius * 0.5, -this.radius * 0.2, this.radius * 0.4, 0, Math.PI, false);
                ctx.fill();
            }
            ctx.fillStyle = baseStyle;

            // Ë∂≥
            ctx.strokeStyle = baseStyle;
            ctx.lineWidth = 2;
            for(let i=0; i<4; i++) {
                ctx.beginPath();
                const x = -this.radius * 0.5 + i * this.radius * 0.4;
                ctx.moveTo(x, this.radius * 0.3);
                ctx.lineTo(x - 2, this.radius * 0.8);
                ctx.stroke();
            }

            // Â∞ªÂ∞æ
            ctx.beginPath();
            ctx.moveTo(-this.radius, 0);
            ctx.lineTo(-this.radius * 1.75, this.radius * 0.25);
            ctx.lineTo(-this.radius * 1.75, -this.radius * 0.25);
            ctx.fill();
        }

        // Èï∑„ÅÑËß¶Ëßí
        ctx.strokeStyle = '#FF4500';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(this.radius, -5);
        ctx.quadraticCurveTo(this.radius + 20, -20, this.radius + 10, -30);
        ctx.moveTo(this.radius, -5);
        ctx.quadraticCurveTo(this.radius + 25, -15, this.radius + 15, -35);
        ctx.stroke();

        // ÁõÆÔºà„Åã„Çè„ÅÑ„ÅïÈáçË¶ñÔºâ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.radius * 0.8, -5, 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.radius * 0.9, -5, 2, 0, Math.PI * 2);
        ctx.fill();
        // ÁõÆ„ÅÆ„Éè„Ç§„É©„Ç§„Éà
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.radius * 0.9 - 1, -5 - 1, 1, 0, Math.PI * 2);
        ctx.fill();
    }
}

/**
 * Êïµ„ÇØ„É©„ÇπÁæ§
 */
class Enemy {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.markedForDeletion = false;
    }
    update(speed) { this.x -= speed; }
    draw(ctx) {}
    isOffScreen(w, h) { return this.x < -100 || this.y > h + 100; }
    checkCollision(player) {
        // Á∞°ÊòìÂÜÜÂΩ¢ÂΩì„Åü„ÇäÂà§ÂÆö
        const dx = this.x - player.x;
        const dy = this.y - player.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        return distance < (this.radius + player.radius);
    }
}

class Fish extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 15;
        this.extraSpeed = Math.random() * 2;
        this.angle = Math.random() * Math.PI * 2;
    }
    update(baseSpeed) { 
        this.x -= (baseSpeed + this.extraSpeed);
        // Âãï„Åç„ÇíÂ∑•Â§´: ‰∏ä‰∏ã„Å´„ÇÜ„Çâ„ÇÜ„ÇâÊè∫„Çå„Çã
        this.y += Math.sin(this.angle += 0.05) * 1.5;
    }
    draw(ctx) {
        // Â∑¶Âêë„Åç
        const grad = ctx.createLinearGradient(this.x + 25, this.y - 15, this.x - 25, this.y + 15);
        grad.addColorStop(0, '#5F9EA0');
        grad.addColorStop(1, '#4682B4');
        ctx.fillStyle = grad;
        
        // ‰ΩìÔºàÊµÅÁ∑öÂûãÔºâ
        ctx.beginPath();
        ctx.moveTo(this.x - 25, this.y); // È†≠ÔºàÂ∑¶Ôºâ
        ctx.quadraticCurveTo(this.x, this.y - 20, this.x + 25, this.y); // ËÉå‰∏≠
        ctx.quadraticCurveTo(this.x, this.y + 20, this.x - 25, this.y); // ËÖπ
        ctx.fill();
        
        // È±óÊ®°Êßò
        ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
        for(let i=0; i<3; i++) {
            for(let j=0; j<3; j++) {
                ctx.beginPath();
                ctx.arc(this.x + 10 - i*10, this.y - 6 + j*6, 4, 0, Math.PI, false);
                ctx.fill();
            }
        }

        // Â∞æ„Å≥„Çå
        ctx.fillStyle = '#4682B4';
        ctx.beginPath();
        ctx.moveTo(this.x + 20, this.y);
        ctx.lineTo(this.x + 35, this.y - 12);
        ctx.lineTo(this.x + 35, this.y + 12);
        ctx.fill();

        // ËÉ∏„Éì„É¨
        ctx.fillStyle = '#87CEFA';
        ctx.beginPath();
        ctx.ellipse(this.x, this.y + 3, 8, 4, Math.PI / 4, 0, Math.PI * 2);
        ctx.fill();

        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 12, this.y - 5, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 13, this.y - 5, 2, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Sardine extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 12;
        this.speed = 2.0;
        this.angle = Math.random() * Math.PI * 2;
    }
    update(baseSpeed) {
        this.x -= (baseSpeed + this.speed);
        this.y += Math.sin(this.angle += 0.1) * 0.5;
    }
    draw(ctx) {
        // „Ç§„ÉØ„Ç∑„Å£„ÅΩ„ÅèÔºàÈäÄËâ≤„ÄÅÊñëÁÇπÔºâ
        const grad = ctx.createLinearGradient(this.x, this.y - 8, this.x, this.y + 8);
        grad.addColorStop(0, '#708090'); // SlateGray (ËÉå‰∏≠)
        grad.addColorStop(0.4, '#C0C0C0'); // Silver (ÂÅ¥Èù¢)
        grad.addColorStop(1, '#F5F5F5'); // WhiteSmoke (ËÖπ)
        ctx.fillStyle = grad;
        
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 20, 7, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ÊñëÁÇπÔºà„Ç§„ÉØ„Ç∑„ÅÆÁâπÂæ¥Ôºâ
        ctx.fillStyle = '#2F4F4F';
        for(let i=0; i<3; i++) {
            ctx.beginPath();
            ctx.arc(this.x - 5 + i*7, this.y - 1, 1.5, 0, Math.PI*2);
            ctx.fill();
        }

        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 14, this.y - 1, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 14, this.y - 1, 1.5, 0, Math.PI * 2);
        ctx.fill();
        
        // Â∞æ„Å≥„Çå
        ctx.fillStyle = '#708090';
        ctx.beginPath();
        ctx.moveTo(this.x + 18, this.y);
        ctx.lineTo(this.x + 24, this.y - 5);
        ctx.lineTo(this.x + 24, this.y + 5);
        ctx.fill();
    }
}

class Tuna extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 25;
        this.speed = 10.0; // „Å®„Å¶„ÇÇÈÄü„ÅÑ
    }
    update(baseSpeed) {
        this.x -= (baseSpeed + this.speed);
    }
    draw(ctx) {
        // „É°„Çø„É™„ÉÉ„ÇØ„Å™„Éú„Éá„Ç£
        const grad = ctx.createLinearGradient(this.x - 40, this.y - 20, this.x + 40, this.y + 20);
        grad.addColorStop(0, '#000080'); // Navy
        grad.addColorStop(0.4, '#4169E1'); // RoyalBlue
        grad.addColorStop(1, '#C0C0C0'); // Silver (ËÖπ)
        ctx.fillStyle = grad;

        // Á¥°ÈåòÂΩ¢„ÅÆ‰Ωì
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 45, 18, 0, 0, Math.PI * 2);
        ctx.fill();

        // Ê®™Á∏û„É©„Ç§„É≥
        ctx.strokeStyle = 'rgba(0,0,0,0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(this.x - 30, this.y);
        ctx.lineTo(this.x + 30, this.y);
        ctx.stroke();

        // ÈªÑËâ≤„ÅÑÂ∞èÈõ¢È∞≠ÔºàËÉå‰∏≠„Å®ËÖπ„ÅÆÂæå„Çç„ÅÆÊñπ„Å´„ÅÇ„Çã„ÇÆ„Ç∂„ÇÆ„Ç∂Ôºâ
        ctx.fillStyle = '#FFD700';
        for(let i=0; i<5; i++) {
            // ËÉåÂÅ¥
            ctx.beginPath();
            ctx.moveTo(this.x + 10 + i*5, this.y - 16);
            ctx.lineTo(this.x + 13 + i*5, this.y - 22);
            ctx.lineTo(this.x + 16 + i*5, this.y - 15);
            ctx.fill();
            // ËÖπÂÅ¥
            ctx.beginPath();
            ctx.moveTo(this.x + 10 + i*5, this.y + 16);
            ctx.lineTo(this.x + 13 + i*5, this.y + 22);
            ctx.lineTo(this.x + 16 + i*5, this.y + 15);
            ctx.fill();
        }

        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 25, this.y - 3, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 25, this.y - 3, 2, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Shark extends Enemy {
    constructor(x, y, player) {
        super(x, y);
        this.player = player;
        this.radius = 30;
        this.speed = 6.5;
    }
    update(baseSpeed) {
        this.x -= (baseSpeed + this.speed);
        // „Éõ„Éº„Éü„É≥„Ç∞Ôºà„Éó„É¨„Ç§„É§„Éº„ÅÆYÂ∫ßÊ®ô„Å´Ëøë„Å•„ÅèÔºâ
        if (this.player) {
            const dy = this.player.y - this.y;
            this.y += dy * 0.025; // ËøΩÂ∞æÊÄßËÉΩ„Ç¢„ÉÉ„Éó
        }
    }
    draw(ctx) {
        ctx.fillStyle = '#708090'; // SlateGray
        
        // ‰Ωì
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 40, 18, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ËÉå„Å≥„Çå
        ctx.beginPath();
        ctx.moveTo(this.x + 5, this.y - 10);
        ctx.lineTo(this.x - 5, this.y - 30);
        ctx.lineTo(this.x - 15, this.y - 10);
        ctx.fill();
        
        // Â∞æ„Å≥„Çå
        ctx.beginPath();
        ctx.moveTo(this.x + 35, this.y);
        ctx.lineTo(this.x + 55, this.y - 15);
        ctx.lineTo(this.x + 55, this.y + 15);
        ctx.fill();
        
        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 25, this.y - 5, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 27, this.y - 5, 1.5, 0, Math.PI * 2);
        ctx.fill();
        
        // „Ç®„É©
        ctx.strokeStyle = '#506070';
        ctx.lineWidth = 2;
        for(let i=0; i<3; i++) {
            ctx.beginPath();
            ctx.moveTo(this.x - 10 + i*5, this.y - 5);
            ctx.lineTo(this.x - 10 + i*5, this.y + 5);
            ctx.stroke();
        }
    }
}

class Anglerfish extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 25;
        this.angle = Math.random() * Math.PI * 2;
    }
    update(speed) {
        this.x -= speed * 0.7; // Â∞ë„ÅóÈÅÖ„ÇÅ
        this.y += Math.sin(this.angle += 0.03) * 0.5;
    }
    draw(ctx) {
        // Êöó„ÅÑ‰ΩìËâ≤
        ctx.fillStyle = '#191970'; // MidnightBlue
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 30, 25, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Âè£
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.moveTo(this.x - 20, this.y + 5);
        ctx.lineTo(this.x - 10, this.y + 15);
        ctx.lineTo(this.x + 10, this.y + 5);
        ctx.fill();
        
        // ÊèêÁÅØ„ÅÆÊüÑ
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y - 25);
        ctx.quadraticCurveTo(this.x + 20, this.y - 50, this.x + 40, this.y - 10);
        ctx.stroke();

        // ÊèêÁÅØ„ÅÆÂÖâ
        ctx.fillStyle = '#ADFF2F'; // GreenYellow
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ADFF2F';
        ctx.beginPath();
        ctx.arc(this.x + 40, this.y - 10, 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}

class Hook extends Enemy {
    constructor(x, y) {
        // ÁîªÈù¢Âè≥ÂÅ¥„Å´Âá∫Áèæ„Åï„Åõ„Çã
        super(x * 0.8 + Math.random() * (x * 0.2), y);
        this.radius = 10;
        this.vy = 4.5; // ËêΩ‰∏ãÈÄüÂ∫¶„Ç¢„ÉÉ„Éó
    }
    update(speed, game) {
        this.x -= speed; // „Çπ„ÇØ„É≠„Éº„É´„Å´Âêà„Çè„Åõ„Å¶ÁßªÂãï
        this.y += this.vy; // ‰∏ä„Åã„Çâ‰∏ã„Å∏
        if (game) {
            const groundY = game.getGroundY(this.x);
            if (this.y > groundY) this.y = groundY;
        }
    }
    draw(ctx) {
        const grad = ctx.createLinearGradient(this.x - 5, this.y, this.x + 5, this.y);
        grad.addColorStop(0, '#C0C0C0');
        grad.addColorStop(1, '#696969');
        ctx.strokeStyle = grad;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(this.x, -100); // Á≥∏ÔºàÁîªÈù¢‰∏äÁ´Ø„Çà„Çä‰∏ä„Åæ„ÅßÁ¢∫ÂÆü„Å´Âºï„ÅèÔºâ
        ctx.lineTo(this.x, this.y);
        ctx.stroke();
        
        // Èáù„ÅÆJ„ÅÆÂ≠ó
        ctx.beginPath();
        ctx.arc(this.x - 5, this.y, 10, 0, Math.PI, false);
        ctx.stroke();
    }
}

class Net extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 80; // Â§ß„Åç„Åè
        this.angle = 0;
    }
    update(speed) {
        this.x -= speed;
        this.y += Math.sin(this.angle += 0.02) * 1;
    }
    draw(ctx) {
        if (!isFinite(this.x) || !isFinite(this.y)) return;

        ctx.strokeStyle = '#5D4037'; // ÊøÉ„ÅÑËå∂Ëâ≤
        ctx.lineWidth = 3;
        ctx.fillStyle = 'rgba(100, 100, 100, 0.2)'; // ËñÑÊöó„ÅÑÁ∂≤„ÅÆËâ≤
        
        // ‰∏äÈÉ®„ÅÆ„É≠„Éº„Éó
        ctx.beginPath();
        ctx.moveTo(this.x - 60, this.y - 70);
        ctx.quadraticCurveTo(this.x, this.y - 60, this.x + 60, this.y - 70);
        ctx.stroke();

        // ÊµÆ„ÅçÔºà„Éï„É≠„Éº„ÉàÔºâ
        ctx.fillStyle = '#FFD700';
        for(let i=-50; i<=50; i+=25) {
            ctx.beginPath();
            ctx.arc(this.x + i, this.y - 65 + Math.abs(i)*0.1, 5, 0, Math.PI*2);
            ctx.fill();
        }

        // Á∂≤Ë¢ã
        ctx.fillStyle = 'rgba(100, 100, 100, 0.1)';
        ctx.beginPath();
        ctx.moveTo(this.x - 60, this.y - 70);
        ctx.bezierCurveTo(this.x - 70, this.y, this.x - 30, this.y + 70, this.x, this.y + 80);
        ctx.bezierCurveTo(this.x + 30, this.y + 70, this.x + 70, this.y, this.x + 60, this.y - 70);
        ctx.fill();
        ctx.stroke();

        // Á∂≤ÁõÆÔºà„ÇØ„É™„ÉÉ„Éî„É≥„Ç∞„Åó„Å¶ÊèèÁîªÔºâ
        ctx.save();
        ctx.clip();
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i = -80; i < 80; i += 10) {
            ctx.moveTo(this.x + i, this.y - 80);
            ctx.lineTo(this.x + i - 40, this.y + 100);
            ctx.moveTo(this.x + i, this.y - 80);
            ctx.lineTo(this.x + i + 40, this.y + 100);
        }
        ctx.stroke();
        ctx.restore();
    }
}

class Squid extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 18;
        this.baseY = y;
        this.timer = 0;
    }
    update(speed) {
        this.x -= speed;
        this.timer += 0.05;
        // Ê≥¢Êâì„Å§Âãï„ÅçÔºà„Çµ„Ç§„É≥Ê≥¢Ôºâ
        this.y = this.baseY + Math.sin(this.timer) * 80;
    }
    draw(ctx) {
        const grad = ctx.createRadialGradient(this.x, this.y - 10, 0, this.x, this.y, 20);
        grad.addColorStop(0, '#FFF5EE');
        grad.addColorStop(1, '#FFE4E1');
        ctx.fillStyle = grad;
        
        // È†≠Ôºà„Ç®„É≥„Éö„É©Ôºâ
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 15, 15, 20, 0, Math.PI, 0); // ‰∏äÂçäÂàÜ
        ctx.lineTo(this.x + 15, this.y);
        ctx.lineTo(this.x - 15, this.y);
        ctx.fill();
        
        // „Éí„É¨
        ctx.beginPath();
        ctx.moveTo(this.x - 15, this.y - 25);
        ctx.lineTo(this.x - 25, this.y - 15);
        ctx.lineTo(this.x - 13, this.y - 10);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(this.x + 15, this.y - 25);
        ctx.lineTo(this.x + 25, this.y - 15);
        ctx.lineTo(this.x + 13, this.y - 10);
        ctx.fill();

        // Ë∂≥ÔºàËß¶ËÖïÔºâ
        ctx.strokeStyle = '#FFF5EE';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        for(let i=-10; i<=10; i+=5) {
            ctx.beginPath();
            ctx.moveTo(this.x + i, this.y);
            ctx.quadraticCurveTo(this.x + i + Math.sin(this.timer * 2 + i)*5, this.y + 15, this.x + i, this.y + 30);
            ctx.stroke();
        }
        
        // ÁõÆ
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 8, this.y - 5, 3, 0, Math.PI*2);
        ctx.arc(this.x + 8, this.y - 5, 3, 0, Math.PI*2);
        ctx.fill();
    }
}

class Jellyfish extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 20;
        this.angle = Math.random() * Math.PI * 2;
        this.electricTimer = 0;
        this.isElectric = false;
    }
    update(speed) {
        this.x -= speed;
        this.y += Math.sin(this.angle += 0.05) * 0.5;
        
        // ÊîæÈõª„Çµ„Ç§„ÇØ„É´
        this.electricTimer++;
        if (this.electricTimer > 120) { // 2ÁßíÂë®Êúü
            this.isElectric = !this.isElectric;
            this.electricTimer = 0;
        }
    }
    draw(ctx) {
        // ÂÇò
        ctx.fillStyle = this.isElectric ? 'rgba(255, 255, 0, 0.6)' : 'rgba(173, 216, 230, 0.5)';
        if (this.isElectric && Math.floor(Date.now() / 50) % 2 === 0) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; // ÁÇπÊªÖ
        }
        ctx.beginPath();
        ctx.arc(this.x, this.y - 5, 20, Math.PI, 0);
        ctx.lineTo(this.x + 20, this.y + 5);
        ctx.lineTo(this.x - 20, this.y + 5);
        ctx.fill();

        // Ë∂≥
        ctx.strokeStyle = this.isElectric ? '#FFFF00' : 'rgba(173, 216, 230, 0.8)';
        ctx.lineWidth = 2;
        for(let i=-10; i<=10; i+=5) {
            ctx.beginPath();
            ctx.moveTo(this.x + i, this.y + 5);
            ctx.lineTo(this.x + i + Math.sin(this.angle + i)*5, this.y + 25);
            ctx.stroke();
        }
    }
}

class ElectricEel extends Enemy {
    constructor(x, y, player) {
        super(x, y);
        this.player = player;
        this.radius = 20;
        this.speed = 4.5;
        this.angle = 0;
        this.electricTimer = 0;
    }
    update(baseSpeed) {
        this.x -= (baseSpeed + this.speed);
        // „Éó„É¨„Ç§„É§„Éº„ÇíËøΩÂ∞æ (YËª∏)
        if (this.player) {
            const dy = this.player.y - this.y;
            this.y += dy * 0.02;
        }
        // „ÅÜ„Å≠„ÅÜ„Å≠Âãï„Åè
        this.y += Math.sin(this.angle += 0.2) * 3;
        this.electricTimer++;
    }
    draw(ctx) {
        // ‰Ωì
        ctx.fillStyle = '#4B0082'; // Indigo
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 40, 10, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ÊîæÈõª„Ç®„Éï„Çß„ÇØ„Éà
        if (Math.floor(this.electricTimer / 5) % 2 === 0) {
            ctx.strokeStyle = '#FFFF00'; // Yellow
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(this.x - 40, this.y);
            for(let i=0; i<10; i++) {
                ctx.lineTo(this.x - 40 + i*8, this.y + (Math.random()-0.5)*20);
            }
            ctx.stroke();
        }
    }
}

class Flatfish extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 15;
        // Á†Ç„Å´Êì¨ÊÖã„Åô„ÇãËâ≤
        this.color = '#D2B48C'; 
        this.mouthOpen = 0;
    }
    draw(ctx, isBiting = false) {
        const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, 25);
        grad.addColorStop(0, '#E6CCB3');
        grad.addColorStop(1, this.color);
        ctx.fillStyle = grad;
        ctx.beginPath();
        // Âπ≥„Åπ„Å£„Åü„ÅÑ‰Ωì
        // ÊçïÈ£üÊôÇ„ÅØÂ∞ë„ÅóËÜ®„Çâ„ÇÄ
        const h = isBiting ? 20 : 10;
        ctx.ellipse(this.x, this.y, 25, h, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ÁõÆ
        // ÊçïÈ£üÊôÇ„ÅØÁõÆ„Åå„Éê„ÉÉ„ÉÜ„É≥„Å´„Å™„Çã„Å™„Å©„ÅÆÊºîÂá∫„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅ„Ç∑„É≥„Éó„É´„Å´
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 5, this.y - 5, 3, 0, Math.PI * 2);
        ctx.arc(this.x + 5, this.y - 5, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 5, this.y - 5, 1, 0, Math.PI * 2);
        ctx.arc(this.x + 5, this.y - 5, 1, 0, Math.PI * 2);
        ctx.fill();
    }
}

class SeaUrchin extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 15;
    }
    draw(ctx) {
        const grad = ctx.createRadialGradient(this.x - 3, this.y - 3, 0, this.x, this.y, 10);
        grad.addColorStop(0, '#4F6F6F');
        grad.addColorStop(1, '#2F4F4F');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 10, 0, Math.PI * 2);
        ctx.fill();
        
        // „Éà„Ç≤
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        for(let i=0; i<8; i++) {
            const angle = (Math.PI * 2 / 8) * i;
            ctx.beginPath();
            ctx.moveTo(this.x, this.y);
            ctx.lineTo(this.x + Math.cos(angle) * 20, this.y + Math.sin(angle) * 20);
            ctx.stroke();
        }
    }
}

class Octopus extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 25;
        this.angle = Math.random() * Math.PI * 2;
        this.moveTimer = 0;
    }
    update(speed) {
        this.x -= speed;
        this.moveTimer += 0.1;
        // ÊøÄ„Åó„ÅÑÂãï„Åç: Â§ß„Åç„Å™„Çµ„Ç§„É≥Ê≥¢ + Â∞èÂàª„Åø„Å™Èúá„Åà
        this.y += Math.sin(this.moveTimer) * 4 + Math.sin(this.moveTimer * 3) * 2;
    }
    draw(ctx) {
        const grad = ctx.createRadialGradient(this.x, this.y - 10, 2, this.x, this.y - 5, 15);
        grad.addColorStop(0, '#E9967A');
        grad.addColorStop(1, '#CD5C5C');
        ctx.fillStyle = grad;
        // È†≠
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 15, 20, 25, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Ë∂≥
        ctx.strokeStyle = '#CD5C5C';
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        for(let i=0; i<4; i++) {
            ctx.beginPath();
            const startX = this.x - 15 + i*10;
            ctx.moveTo(startX, this.y);
            const sway = Math.sin(this.moveTimer + i) * 10;
            ctx.quadraticCurveTo(startX + sway, this.y + 20, startX, this.y + 40);
            ctx.stroke();
            
            // Âê∏Áõ§
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.beginPath();
            ctx.arc(startX + sway*0.5, this.y + 20, 2, 0, Math.PI*2);
            ctx.fill();
        }

        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 8, this.y - 10, 5, 0, Math.PI * 2);
        ctx.arc(this.x + 8, this.y - 10, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 8, this.y - 10, 2, 0, Math.PI * 2);
        ctx.arc(this.x + 8, this.y - 10, 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Âè£Ôºà„Çø„Ç≥„ÉÅ„É•„ÉºÔºâ
        ctx.strokeStyle = '#8B0000';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(this.x, this.y - 2, 3, 0, Math.PI * 2);
        ctx.stroke();
    }
}

class Porcupinefish extends Enemy {
    constructor(x, y, game) {
        super(x, y);
        this.radius = 20;
        this.game = game;
        this.timer = 0;
        this.hasExploded = false;
        this.scale = 1.0;
    }
    update(speed) {
        this.x -= speed;
        this.timer++;
        
        // ËÜ®„Çâ„ÇÄ‰∫àÂÖÜÔºà„Å∑„Çã„Å∑„ÇãÈúá„Åà„ÇãÔºâ
        if (!this.hasExploded && this.timer > 90 && this.timer <= 120) {
            this.scale = 1.0 + Math.sin((this.timer - 90) * 0.8) * 0.1;
        }

        // ‰∏ÄÂÆöÊôÇÈñìÁµåÈÅé„ÅßÈáù„ÇíÈ£õ„Å∞„Åô
        if (!this.hasExploded && this.timer > 120 && this.x < this.game.width - 50) {
            this.explode();
            this.hasExploded = true;
            this.scale = 0.9; // ÁàÜÁô∫Âæå„ÅØÂ∞ë„Åó„Åó„Åº„ÇÄ
        }
    }
    explode() {
        // 8ÊñπÂêë„Å´Èáù„ÇíÁô∫Â∞Ñ
        for(let i=0; i<8; i++) {
            const angle = (Math.PI * 2 / 8) * i;
            this.game.enemies.push(new Needle(this.x, this.y, Math.cos(angle)*4, Math.sin(angle)*4));
        }
    }
    draw(ctx) {
        const r = this.hasExploded ? 18 : 22;
        
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.scale(this.scale, this.scale);

        // ÁÅ∞Ëâ≤„Éô„Éº„Çπ„ÅÆ„Éú„Éá„Ç£
        const grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, r);
        grad.addColorStop(0, '#D3D3D3'); // LightGray
        grad.addColorStop(1, '#696969'); // DimGray
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, Math.PI * 2);
        ctx.fill();
        
        // ÁõÆÔºàÊÄí„Å£„ÅüÊÑü„ÅòÔºâ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.ellipse(-8, -5, 5, 6, 0, 0, Math.PI*2);
        ctx.ellipse(8, -5, 5, 6, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(-8, -5, 2, 0, Math.PI * 2);
        ctx.arc(8, -5, 2, 0, Math.PI * 2);
        ctx.fill();

        // ÁúâÊØõ
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(-12, -10); ctx.lineTo(-4, -7);
        ctx.moveTo(12, -10); ctx.lineTo(4, -7);
        ctx.stroke();

        // Âè£
        ctx.beginPath();
        ctx.arc(0, 5, 3, 0, Math.PI, false);
        ctx.stroke();

        // „Éà„Ç≤ÔºàÈÄöÂ∏∏ÊôÇ„ÅØÁü≠„Åè„ÄÅÁàÜÁô∫ÊôÇ„ÅØÁÑ°„ÅÑÔºàNeedle„Å´„Å™„ÇãÔºâÔºâ
        if (!this.hasExploded) {
            ctx.fillStyle = '#808080';
            for(let i=0; i<12; i++) {
                const angle = (Math.PI * 2 / 12) * i;
                ctx.beginPath();
                ctx.moveTo(Math.cos(angle)*r, Math.sin(angle)*r);
                ctx.lineTo(Math.cos(angle)*(r+6), Math.sin(angle)*(r+6));
                ctx.lineTo(Math.cos(angle+0.2)*r, Math.sin(angle+0.2)*r);
                ctx.fill();
            }
        }
        
        ctx.restore();
    }
}

class Crab extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 18;
        this.walkTimer = 0;
    }
    update(speed, game) {
        this.x -= speed + 0.5; // Â∞ë„ÅóÊ≠©„Åè
        this.walkTimer += 0.2;
        // Âú∞Èù¢„Å´Êé•Âú∞
        if (game) {
            this.y = game.getGroundY(this.x) - 15;
        }
    }
    draw(ctx) {
        ctx.fillStyle = '#FF6347'; // Tomato
        // Áî≤ÁæÖ
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 20, 14, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 8, this.y - 15, 4, 0, Math.PI * 2);
        ctx.arc(this.x + 8, this.y - 15, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 8, this.y - 15, 1.5, 0, Math.PI * 2);
        ctx.arc(this.x + 8, this.y - 15, 1.5, 0, Math.PI * 2);
        ctx.fill();
        // ÁõÆ„ÅÆËåé
        ctx.strokeStyle = '#FF6347';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x - 8, this.y - 5); ctx.lineTo(this.x - 8, this.y - 15);
        ctx.moveTo(this.x + 8, this.y - 5); ctx.lineTo(this.x + 8, this.y - 15);
        ctx.stroke();

        // „Éè„Çµ„ÉüÔºàÂãï„ÅèÔºâ
        const armY = this.y + Math.sin(this.walkTimer) * 3;
        ctx.fillStyle = '#DC143C';
        ctx.beginPath();
        ctx.ellipse(this.x - 25, armY, 8, 5, -0.5, 0, Math.PI*2);
        ctx.ellipse(this.x + 25, armY, 8, 5, 0.5, 0, Math.PI*2);
        ctx.fill();

        // Ë∂≥
        ctx.strokeStyle = '#FF6347';
        ctx.lineWidth = 2;
        for(let i=0; i<3; i++) {
            const legX = (i - 1) * 10;
            const legY = Math.abs(Math.sin(this.walkTimer + i)) * 5;
            ctx.beginPath();
            ctx.moveTo(this.x + legX, this.y + 5);
            ctx.lineTo(this.x + legX * 1.5, this.y + 15 - legY);
            ctx.stroke();
        }
    }
}

class SeaAnemone extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 15;
        this.timer = Math.random() * 100;
        this.color = ['#FF69B4', '#DA70D6', '#FFB6C1'][Math.floor(Math.random() * 3)];
    }
    update(speed) {
        this.x -= speed;
        this.timer += 0.05;
    }
    draw(ctx) {
        ctx.fillStyle = this.color;
        // Êú¨‰Ωì
        ctx.beginPath();
        ctx.fillRect(this.x - 10, this.y - 10, 20, 10);
        
        // Ëß¶Êâã
        ctx.lineWidth = 3;
        ctx.strokeStyle = this.color;
        ctx.lineCap = 'round';
        for(let i=-8; i<=8; i+=4) {
            ctx.beginPath();
            ctx.moveTo(this.x + i, this.y - 10);
            const sway = Math.sin(this.timer + i) * 5;
            ctx.quadraticCurveTo(this.x + i + sway, this.y - 20, this.x + i + sway*0.5, this.y - 25);
            ctx.stroke();
        }
    }
}

class Starfish extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 15;
        this.angle = Math.random() * Math.PI * 2;
        this.color = ['#FFD700', '#FFA500', '#FF4500'][Math.floor(Math.random() * 3)];
    }
    update(speed) {
        this.x -= speed;
    }
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = this.color;
        
        // ÊòüÂûã„ÇíÊèèÁîª
        ctx.beginPath();
        for (let i = 0; i < 5; i++) {
            ctx.lineTo(Math.cos((18 + i * 72) * Math.PI / 180) * 15,
                       -Math.sin((18 + i * 72) * Math.PI / 180) * 15);
            ctx.lineTo(Math.cos((54 + i * 72) * Math.PI / 180) * 6,
                       -Math.sin((54 + i * 72) * Math.PI / 180) * 6);
        }
        ctx.closePath();
        ctx.fill();
        
        // Ê®°Êßò
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.beginPath();
        ctx.arc(0, 0, 3, 0, Math.PI*2);
        ctx.fill();
        
        ctx.restore();
    }
}

class Needle extends Enemy {
    constructor(x, y, vx, vy) {
        super(x, y);
        this.vx = vx;
        this.vy = vy;
        this.radius = 5;
    }
    update(speed) {
        this.x += this.vx; // ÁîªÈù¢„Çπ„ÇØ„É≠„Éº„É´„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑÔºàÁõ∏ÂØæÈÄüÂ∫¶„Åß„ÅØ„Å™„ÅÑÔºâ
        this.x -= speed;   // „Çπ„ÇØ„É≠„Éº„É´ÂàÜ„ÇÇÂºï„Åè
        this.y += this.vy;
    }
    draw(ctx) {
        ctx.strokeStyle = '#696969';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(this.x - this.vx * 3, this.y - this.vy * 3);
        ctx.stroke();
    }
}

class Whirlpool extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 35;
        this.angle = 0;
    }
    update(speed) {
        this.x -= speed;
        this.angle += 0.2;
    }
    draw(ctx) {
        // „ÇΩ„Éï„Éà„ÇØ„É™„Éº„É†„ÅÆ„Çà„ÅÜ„Å™Ê∏¶ÊΩÆ
        ctx.strokeStyle = 'rgba(224, 255, 255, 0.8)'; // LightCyan
        ctx.lineWidth = 1;
        ctx.beginPath();
        
        const segments = 50;
        for (let i = 0; i < segments; i++) {
            const ratio = i / segments;
            const radius = (1 - ratio) * this.radius;
            const angle = this.angle + i * 0.5;
            const x = this.x + Math.cos(angle) * radius;
            const y = this.y + Math.sin(angle) * radius;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();
        
        // ‰∏≠ÂøÉ
        ctx.fillStyle = 'rgba(0, 0, 139, 0.5)'; // DarkBlue
        ctx.beginPath();
        ctx.arc(this.x, this.y, 5, 0, Math.PI*2);
        ctx.fill();
    }
}

class Whale extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 120; // Â§ß„Åç„Åè
        this.timer = 0;
        this.attackTimer = 0;
    }
    update(speed, game) {
        // „Éú„Çπ„ÅØ„ÇÜ„Å£„Åè„ÇäËø´„Å£„Å¶„Åè„Çã
        this.x -= speed * 0.8; // „Åï„Çâ„Å´ÈÄü„Åè
        this.y += Math.sin(this.timer += 0.02) * 0.5;
        
        // ÊΩÆÂêπ„ÅçÊîªÊíÉ
        this.attackTimer++;
        if (this.attackTimer > 180) { // Á¥Ñ3Áßí„Åî„Å®
            this.attackTimer = 0;
            // ËÉå‰∏≠„ÅÇ„Åü„Çä„Åã„ÇâÊΩÆÂêπ„Åç
            game.enemies.push(new WaterSpout(this.x + 75, this.y - 60));
            
            // Ê∞¥Êª¥„Çí„Å∞„ÇâÊíí„Åè
            for(let i=0; i<5; i++) {
                const vx = (Math.random() - 0.8) * 10; // Â∑¶ÊñπÂêë„Å´È£õ„Å∞„Åô
                const vy = -Math.random() * 15 - 5; // ‰∏ä„Å´Âº∑„ÅèÈ£õ„Å∞„Åô
                game.enemies.push(new WaterDrop(this.x + 75, this.y - 60, vx, vy));
            }
        }
    }
    isOffScreen(w, h) { return this.x < -500; }

    draw(ctx) {
        if (!isFinite(this.x) || !isFinite(this.y)) return;

        ctx.save();
        ctx.translate(this.x, this.y);
        const scale = 1.5; // Â∑®Â§ßÂåñ
        ctx.scale(scale, scale);

        // Ëâ≤„ÇíÂ§âÊõ¥ÔºàÊµ∑„ÅÆËâ≤„Å®ÂêåÂåñ„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´Êòé„Çã„ÇÅ„ÅÆ„Ç∞„É¨„ÉºÁ≥ª„Å´Ôºâ
        const grad = ctx.createLinearGradient(-150, -50, 100, 50);
        grad.addColorStop(0, '#778899'); // LightSlateGray
        grad.addColorStop(1, '#2F4F4F'); // DarkSlateGray
        ctx.fillStyle = grad;
        
        // ‰Ωì
        ctx.beginPath();
        // È†≠ÈÉ®ÔºàÂõõËßí„ÅèÂ§ß„Åç„ÅèÔºâ
        ctx.moveTo(80, -40);
        ctx.lineTo(-100, -50);
        // ËÉå‰∏≠„Åã„ÇâÂ∞æ„Å∏
        ctx.quadraticCurveTo(200, -40, 300, 0);
        // Â∞æ„Åã„ÇâËÖπ„Å∏
        ctx.quadraticCurveTo(200, 40, -80, 50);
        // ‰∏ãÈ°é
        ctx.lineTo(60, 40);
        ctx.quadraticCurveTo(80, 20, 80, -40);
        ctx.fill();

        // ËÖπ„ÅÆÁôΩ„ÅÑÈÉ®ÂàÜ
        ctx.fillStyle = '#E0E0E0';
        ctx.beginPath();
        ctx.moveTo(-80, 50);
        ctx.quadraticCurveTo(100, 40, 200, 10);
        ctx.quadraticCurveTo(100, 20, -60, 30);
        ctx.fill();

        // ËÉ∏„Éì„É¨
        ctx.fillStyle = '#778899';
        ctx.beginPath();
        ctx.moveTo(-20, 20);
        ctx.quadraticCurveTo(-40, 50, -10, 40);
        ctx.fill();

        // Â∞æ„Å≥„Çå
        ctx.beginPath();
        ctx.moveTo(300, 0);
        ctx.lineTo(350, -30);
        ctx.lineTo(350, 30);
        ctx.fill();

        // ÁõÆ
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(-40, 10, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(-41, 10, 2, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }
}

class WaterSpout extends Enemy {
    constructor(x, y) {
        super(x, y);
        this.radius = 30;
        this.life = 60; // 1ÁßíÈñìÊåÅÁ∂ö
        this.maxHeight = 300;
        this.currentHeight = 0;
    }
    update(speed) {
        this.x -= speed * 0.8; // „ÇØ„Ç∏„É©„Å®Âêå„ÅòÈÄüÂ∫¶„ÅßÂãï„Åè
        this.life--;
        if (this.life > 40) {
            this.currentHeight += 20; // ‰º∏„Å≥„Çã
        } else if (this.life < 20) {
            this.currentHeight -= 20; // Á∏Æ„ÇÄ
        }
        // ÂØøÂëΩ„ÅåÂ∞Ω„Åç„Åü„ÇâÁîªÈù¢Â§ñ„Å∏È£õ„Å∞„Åó„Å¶ÂâäÈô§„Åï„Åõ„Çã
        if (this.life <= 0) this.y = 9999;
    }
    draw(ctx) {
        const grad = ctx.createLinearGradient(this.x - 20, this.y, this.x + 20, this.y - this.currentHeight);
        grad.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
        grad.addColorStop(1, 'rgba(173, 216, 230, 0)');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(this.x - 10, this.y);
        ctx.lineTo(this.x - 30, this.y - this.currentHeight);
        ctx.lineTo(this.x + 30, this.y - this.currentHeight);
        ctx.lineTo(this.x + 10, this.y);
        ctx.fill();
    }
    checkCollision(player) {
        // Áü©ÂΩ¢Âà§ÂÆö
        if (player.x > this.x - 30 && player.x < this.x + 30) {
            if (player.y > this.y - this.currentHeight && player.y < this.y) {
                return true;
            }
        }
        return false;
    }
}

class WaterDrop extends Enemy {
    constructor(x, y, vx, vy) {
        super(x, y);
        this.vx = vx;
        this.vy = vy;
        this.radius = 8;
    }
    update(speed) {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.5; // ÈáçÂäõ
        this.x -= speed;
    }
    draw(ctx) {
        ctx.fillStyle = '#87CEFA';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Shipwreck {
    constructor(x, y) {
        this.x = x;
        this.y = y;
    }
    update(scrollSpeed) {
        this.x -= scrollSpeed * 0.5; // „Éë„É©„É©„ÉÉ„ÇØ„Çπ
    }
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.fillStyle = 'rgba(20, 10, 0, 0.4)'; // Êöó„ÅÑËå∂Ëâ≤„ÅÆ„Ç∑„É´„Ç®„ÉÉ„Éà
        // Ëàπ„ÅÆÂΩ¢
        ctx.beginPath();
        ctx.moveTo(-100, 0);
        ctx.lineTo(-80, -40); // ËàπÂ∞æ
        ctx.lineTo(60, -30); // Áî≤Êùø
        ctx.lineTo(100, -10); // ËàπÈ¶ñÔºàÊäò„Çå„Å¶„ÇãÔºâ
        ctx.lineTo(80, 20); // ËàπÂ∫ï
        ctx.lineTo(-90, 20);
        ctx.fill();
        
        // „Éû„Çπ„ÉàÔºàÊäò„Çå„Å¶„ÇãÔºâ
        ctx.lineWidth = 4;
        ctx.strokeStyle = 'rgba(20, 10, 0, 0.4)';
        ctx.beginPath();
        ctx.moveTo(-20, -35);
        ctx.lineTo(-10, -80);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(-10, -60);
        ctx.lineTo(20, -50); // Ê®™Êú®
        ctx.stroke();
        
        ctx.restore();
    }
}

class Pearl {
    constructor(x, y, vx = 0, vy = 0) {
        this.x = x;
        this.y = y;
        this.vx = vx;
        this.vy = vy;
        this.radius = 15;
    }
    update(speed, game) {
        this.x -= speed;
        this.x += this.vx;
        this.y += this.vy;
        
        this.vx *= 0.95; // Êë©Êì¶
        this.vy *= 0.95;

        if (game) {
            const floorY = game.getGroundY(this.x) - 15; // ÂçäÂæÑÂàÜÂºï„Åè
            if (this.y < floorY) {
                this.vy += 0.2; // ÈáçÂäõ
            } else if (this.y > floorY) {
                this.y = floorY;
                this.vy = -this.vy * 0.6; // „Éê„Ç¶„É≥„Éâ
                if(Math.abs(this.vy) < 1) this.vy = 0;
            }
        }
    }
    isOffScreen() { return this.x < -50; }
    checkCollision(player) {
        const dx = this.x - player.x;
        const dy = this.y - player.y;
        return Math.sqrt(dx*dx + dy*dy) < (this.radius + player.radius);
    }
    draw(ctx) {
        // Ë≤ùÊÆª
        const shellGrad = ctx.createLinearGradient(this.x, this.y, this.x, this.y + 20);
        shellGrad.addColorStop(0, '#FFC0CB'); // Pink
        shellGrad.addColorStop(1, '#DB7093'); // PaleVioletRed
        ctx.fillStyle = shellGrad;
        
        // ‰∏ã„ÅÆË≤ù
        ctx.beginPath();
        ctx.arc(this.x, this.y + 10, 15, 0, Math.PI, false);
        ctx.fill();
        // ‰∏ä„ÅÆË≤ùÔºàÈñã„ÅÑ„Å¶„ÅÑ„ÇãÔºâ
        ctx.beginPath();
        ctx.arc(this.x, this.y + 10, 15, Math.PI, 0, false);
        ctx.fill();
        
        // Ëù∂Áï™
        ctx.fillStyle = '#8B4513';
        ctx.beginPath();
        ctx.fillRect(this.x - 3, this.y + 22, 6, 4);
        ctx.fill();

        // ÁúüÁè†
        const pearlGrad = ctx.createRadialGradient(this.x - 2, this.y + 8, 1, this.x, this.y + 10, 8);
        pearlGrad.addColorStop(0, '#FFFFFF');
        pearlGrad.addColorStop(1, '#F0F8FF');
        ctx.fillStyle = pearlGrad;
        ctx.beginPath();
        ctx.arc(this.x, this.y + 10, 8, 0, Math.PI * 2);
        ctx.fill();
        // ÁúüÁè†„ÅÆËºù„Åç
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'white';
        ctx.beginPath();
        ctx.arc(this.x - 2, this.y + 3, 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}

class TreasureChest {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.radius = 20;
    }
    update(speed, game) {
        this.x -= speed;
        if (game) {
            const groundY = game.getGroundY(this.x);
            this.y = groundY - 20;
        }
    }
    isOffScreen() { return this.x < -50; }
    checkCollision(player) {
        const dx = this.x - player.x;
        const dy = this.y - player.y;
        return Math.sqrt(dx*dx + dy*dy) < (this.radius + player.radius);
    }
    draw(ctx) {
        // ÁÆ±
        ctx.fillStyle = '#8B4513'; // SaddleBrown
        ctx.fillRect(this.x - 20, this.y - 15, 40, 30);
        
        // Ëìã„ÅÆ„É©„Ç§„É≥
        ctx.fillStyle = '#A0522D'; // Sienna
        ctx.fillRect(this.x - 20, this.y - 15, 40, 10);
        
        // ÈáëÂÖ∑
        ctx.fillStyle = '#FFD700'; // Gold
        ctx.fillRect(this.x - 5, this.y - 5, 10, 10); // ÈçµÁ©¥
        ctx.fillRect(this.x - 20, this.y - 15, 40, 4); // ‰∏ä„ÅÆÁ∏Å
        ctx.fillRect(this.x - 20, this.y + 11, 40, 4); // ‰∏ã„ÅÆÁ∏Å
        ctx.fillRect(this.x - 20, this.y - 15, 4, 30); // Â∑¶„ÅÆÁ∏Å
        ctx.fillRect(this.x + 16, this.y - 15, 4, 30); // Âè≥„ÅÆÁ∏Å
        
        // Ëºù„Åç
        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.beginPath();
        ctx.moveTo(this.x - 15, this.y - 10);
        ctx.lineTo(this.x - 5, this.y - 10);
        ctx.lineTo(this.x - 15, this.y + 10);
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}

class Plankton {
    constructor(x, y, vx = 0, vy = 0) {
        this.x = x;
        this.y = y;
        this.vx = vx;
        this.vy = vy;
        this.radius = 8;
        this.angle = Math.random() * Math.PI * 2;
    }
    update(speed) {
        this.x -= speed;
        this.x += this.vx;
        this.y += this.vy;
        this.vx *= 0.95;
        this.vy *= 0.95;
        this.y += Math.sin(this.angle += 0.1) * 0.5; // „Åµ„Çè„Åµ„Çè
    }
    isOffScreen() { return this.x < -50; }
    checkCollision(player) {
        const dx = this.x - player.x;
        const dy = this.y - player.y;
        return Math.sqrt(dx*dx + dy*dy) < (this.radius + player.radius);
    }
    draw(ctx) {
        // „Éó„É©„É≥„ÇØ„Éà„É≥ÔºàÂæÆÁîüÁâ©È¢®„Éá„Ç∂„Ç§„É≥Ôºâ
        ctx.fillStyle = 'rgba(152, 251, 152, 0.4)'; // PaleGreen, translucent
        ctx.beginPath();
        // Â∞ë„ÅóÊ≠™„Çì„Å†ÂÜÜ
        const r = this.radius;
        ctx.moveTo(this.x + r, this.y);
        for(let i=1; i<=8; i++) {
            const angle = i * Math.PI / 4;
            const dist = r + Math.sin(Date.now() / 200 + i * 2) * 2;
            ctx.lineTo(this.x + Math.cos(angle) * dist, this.y + Math.sin(angle) * dist);
        }
        ctx.closePath();
        ctx.fill();

        // Ê†∏
        ctx.fillStyle = '#32CD32'; // LimeGreen
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
        ctx.fill();
        
        // ÂÜÖÈÉ®„ÅÆÁ≤í
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        for(let i=0; i<3; i++) {
            ctx.beginPath();
            ctx.arc(this.x + (Math.random()-0.5)*6, this.y + (Math.random()-0.5)*6, 1, 0, Math.PI*2);
            ctx.fill();
        }

        ctx.shadowBlur = 5;
        ctx.shadowColor = '#90EE90';
        ctx.fill();
        ctx.shadowBlur = 0;
    }
}

class FriendShrimp extends Plankton {
    constructor(x, y) {
        super(x, y);
        this.radius = 12;
    }
    draw(ctx) {
        // „Ç¢„Ç§„ÉÜ„É†„Å®„Åó„Å¶„ÅÆ‰ª≤Èñì„Ç®„Éì„ÇÇ„Ç®„Éì„Çâ„Åó„ÅÑË¶ã„ÅüÁõÆ„Å´
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.fillStyle = '#FFB6C1'; // LightPink
        
        // ‰Ωì
        ctx.beginPath();
        ctx.ellipse(0, 0, 12, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ÁØÄ
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.beginPath();
        ctx.arc(-3, -2, 3, 0, Math.PI, false);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(3, -2, 3, 0, Math.PI, false);
        ctx.fill();

        // Â∞ªÂ∞æ
        ctx.fillStyle = '#FFB6C1';
        ctx.beginPath();
        ctx.moveTo(-10, 0);
        ctx.lineTo(-16, 5);
        ctx.lineTo(-16, -5);
        ctx.fill();
        
        // ÁõÆ
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(8, -2, 1.5, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore();
    }
}

class Seaweed {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.height = Math.random() * 100 + 80; // Â§ß„Åç„Åè„Åô„Çã
        this.swayOffset = Math.random() * Math.PI * 2;
    }
    update(speed) { this.x -= speed; }
    draw(ctx, frameCount) {
        const sway = Math.sin(frameCount * 0.05 + this.swayOffset) * 20;
        ctx.strokeStyle = '#2E8B57'; // SeaGreen
        ctx.lineWidth = 10; // Â§™„Åè„Åô„Çã
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.quadraticCurveTo(this.x + sway, this.y - this.height / 2, this.x + sway * 0.5, this.y - this.height);
        ctx.stroke();
    }
}

class RuggedTerrain {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.width = Math.random() * 300 + 250; // ÂπÖ„ÇíÂ§ß„Åç„Åè
        this.baseHeight = Math.random() * 200 + 100; // È´ò„Åï„ÇíÂ§ß„Åç„Åè
        this.points = [];
        // Áõ∏ÂØæÂ∫ßÊ®ô„Åß„Éù„Ç§„É≥„Éà„ÇíÁîüÊàêÔºà„É™„Éó„É¨„Ç§ÊôÇ„ÅÆÊèèÁîªÂ¥©„ÇåÈò≤Ê≠¢Ôºâ
        const segments = 10;
        for (let i = 0; i <= segments; i++) {
            const px = (i / segments) * this.width; // x„ÅØ0„Åã„Çâ„ÅÆÁõ∏ÂØæ
            const py = this.y - this.baseHeight - (Math.random() - 0.5) * 80;
            this.points.push({x: px, y: py - this.y}); // y„ÇÇthis.y„Åã„Çâ„ÅÆÁõ∏ÂØæ
        }
    }
    update(speed, game) { 
        this.x -= speed;
        // points„ÅØÁõ∏ÂØæÂ∫ßÊ®ô„Å™„ÅÆ„ÅßÊõ¥Êñ∞‰∏çË¶Å
    }
    draw(ctx) {
        const grad = ctx.createLinearGradient(this.x, this.y - this.baseHeight, this.x, this.y);
        grad.addColorStop(0, '#606060');
        grad.addColorStop(1, '#404040');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(this.x + this.points[0].x, this.y);
        this.points.forEach(p => ctx.lineTo(this.x + p.x, this.y + p.y));
        ctx.lineTo(this.x + this.points[this.points.length - 1].x, this.y);
        ctx.fill();

        // „Éè„Ç§„É©„Ç§„Éà
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x + this.points[0].x, this.y + this.points[0].y);
        for(let i=1; i<this.points.length; i++) {
            // ‰∏äÂêë„Åç„ÅÆËæ∫„Å´„ÅÆ„Åø„Éè„Ç§„É©„Ç§„Éà
            if (this.points[i].y < this.points[i-1].y) {
                ctx.moveTo(this.x + this.points[i-1].x, this.y + this.points[i-1].y);
                ctx.lineTo(this.x + this.points[i].x, this.y + this.points[i].y);
            }
        }
        ctx.stroke();
    }
    
    getSurfaceInfo(x) {
        // x„ÅØÁµ∂ÂØæÂ∫ßÊ®ô
        for (let i = 0; i < this.points.length - 1; i++) {
            const p1x = this.x + this.points[i].x;
            const p2x = this.x + this.points[i+1].x;
            
            if (x >= p1x && x <= p2x) {
                const ratio = (x - p1x) / (p2x - p1x);
                const p1y = this.y + this.points[i].y;
                const p2y = this.y + this.points[i+1].y;
                
                const y = p1y + (p2y - p1y) * ratio;
                const slope = (p2y - p1y) / (p2x - p1x);
                return { y: y, slope: slope };
            }
        }
        return null;
    }

    checkSideCollision(player) {
        // Â∑¶ÂÅ¥Èù¢„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
        const leftEdgeTop = {x: this.x + this.points[0].x, y: this.y + this.points[0].y};
        const leftEdgeBottom = {x: this.x + this.points[0].x, y: this.y};
        const dist = this.distToSegment(player, leftEdgeTop, leftEdgeBottom);
        return dist < player.radius;
    }

    distToSegment(p, v, w) {
        const l2 = (w.x - v.x)**2 + (w.y - v.y)**2;
        if (l2 === 0) return Math.sqrt((p.x - v.x)**2 + (p.y - v.y)**2);
        let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
        t = Math.max(0, Math.min(1, t));
        return Math.sqrt((p.x - (v.x + t * (w.x - v.x)))**2 + (p.y - (v.y + t * (w.y - v.y)))**2);
    }
}

class Coral {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.color = ['#CD5C5C', '#B22222', '#8B4513'][Math.floor(Math.random() * 3)];
        this.branches = [];
        // ÊûùÂàÜ„Åã„Çå„Åó„Åü„Çµ„É≥„Ç¥
        for(let i=0; i<8; i++) {
            const h = Math.random() * 50 + 30;
            const angle = (Math.random() - 0.5) * 1.0; // ÂÇæ„Åç
            this.branches.push({
                x: (Math.random() - 0.5) * 40,
                h: h,
                w: Math.random() * 8 + 4,
                angle: angle
            });
        }
    }
    update(speed) { this.x -= speed; }
    draw(ctx) {
        ctx.fillStyle = this.color;
        this.branches.forEach(b => {
            ctx.beginPath();
            ctx.save();
            ctx.translate(this.x + b.x, this.y);
            ctx.rotate(b.angle);
            ctx.roundRect(-b.w/2, -b.h, b.w, b.h, b.w/2);
            ctx.fill();
            ctx.restore();
        });
        // ËÉåÊôØ„Å®„Åó„Å¶È¶¥Êüì„Åæ„Åõ„Çã
        ctx.fillStyle = 'rgba(0, 20, 40, 0.2)';
        this.branches.forEach(b => {
            ctx.beginPath();
            ctx.save();
            ctx.translate(this.x + b.x, this.y);
            ctx.rotate(b.angle);
            ctx.roundRect(-b.w/2, -b.h, b.w, b.h, b.w/2);
            ctx.fill();
            ctx.restore();
        });
    }
}

class Clownfish {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.radius = 12;
        this.angle = 0;
    }
    update(speed) {
        this.x -= speed;
        this.y += Math.sin(this.angle += 0.1) * 0.5;
    }
    isOffScreen() { return this.x < -50; }
    checkCollision(player) {
        const dx = this.x - player.x;
        const dy = this.y - player.y;
        return Math.sqrt(dx*dx + dy*dy) < (this.radius + player.radius);
    }
    draw(ctx) {
        // „Ç´„ÇØ„É¨„ÇØ„Éû„Éé„ÉüÔºà„Ç™„É¨„É≥„Ç∏„Å´ÁôΩÂ∏ØÔºâ
        ctx.fillStyle = '#FF4500'; // OrangeRed
        ctx.beginPath();
        ctx.ellipse(this.x, this.y, 15, 8, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // ÁôΩÂ∏Ø
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.fillRect(this.x - 5, this.y - 7, 3, 14);
        ctx.fillRect(this.x + 3, this.y - 6, 3, 12);
        ctx.fill();
        
        // ÁõÆ
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 8, this.y - 2, 1.5, 0, Math.PI * 2);
        ctx.fill();
    }
}

class GardenEel {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.radius = 10;
        this.height = 30;
    }
    update(speed) {
        this.x -= speed;
    }
    isOffScreen() { return this.x < -50; }
    checkCollision(player) {
        const dx = this.x - player.x;
        const dy = (this.y - 15) - player.y; // ÂΩì„Åü„ÇäÂà§ÂÆö„ÅØÈ†≠‰ªòËøë
        return Math.sqrt(dx*dx + dy*dy) < (this.radius + player.radius);
    }
    draw(ctx) {
        // „ÉÅ„É≥„Ç¢„Éä„Ç¥ÔºàÁôΩ„Å´ÈªíÁÇπÔºâ
        ctx.fillStyle = '#F0F8FF'; // AliceBlue
        ctx.beginPath();
        ctx.roundRect(this.x - 4, this.y - this.height, 8, this.height, 4);
        ctx.fill();
        
        // ÈªíÁÇπ
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x, this.y - 20, 1.5, 0, Math.PI * 2);
        ctx.arc(this.x, this.y - 10, 1.5, 0, Math.PI * 2);
        ctx.fill();
        
        // ÁõÆ
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(this.x - 2, this.y - 26, 1, 0, Math.PI * 2);
        ctx.fill();
    }
}

class Bubble {
    constructor(x, y, isBackground = false) {
        this.x = x;
        this.y = y;
        this.size = Math.random() * 5 + 2;
        this.isBackground = isBackground;
        
        if (isBackground) {
            this.life = Math.random() * 0.5 + 0.1; // ËÉåÊôØÁî®„ÅØËñÑ„Åè
            this.decay = 0.002 + Math.random() * 0.003; // Èï∑ÊåÅ„Å°
            this.vy = Math.random() * 1.5 + 0.5; // ‰∏äÊòáÈÄüÂ∫¶
            this.vxFactor = 0.1; // „Çπ„ÇØ„É≠„Éº„É´ÂΩ±ÈüøÂ∞ë„Å™„ÇÅÔºàÈÅ†ÊôØÊÑüÔºâ
        } else {
            this.life = 1.0;
            this.decay = 0.02;
            this.vy = 1;
            this.vxFactor = 0.5;
        }
    }
    update(speed) {
        this.x -= speed * this.vxFactor;
        this.y -= this.vy;
        this.life -= this.decay;
    }
    draw(ctx) {
        ctx.fillStyle = `rgba(255, 255, 255, ${Math.max(0, this.life)})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

class StreamLine {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.length = Math.random() * 100 + 50;
    }
    update(speed) {
        this.x -= speed;
    }
    draw(ctx) {
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(this.x + this.length, this.y);
        ctx.stroke();
    }
}

class FloatingText {
    constructor(x, y, text, color) {
        this.x = x;
        this.y = y;
        this.text = text;
        this.color = color;
        this.life = 1.0;
        this.vy = -1.5;
    }
    update() {
        this.y += this.vy;
        this.life -= 0.02;
    }
    draw(ctx) {
        ctx.save();
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.font = 'bold 24px "M PLUS Rounded 1c", sans-serif';
        ctx.shadowColor = 'black';
        ctx.shadowBlur = 4;
        ctx.fillText(this.text, this.x, this.y);
        ctx.restore();
    }
}

// „Ç≤„Éº„É†ÈñãÂßã
window.onload = () => new Game();

</script>
</body>
</html>
